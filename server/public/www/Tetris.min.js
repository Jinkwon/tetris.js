/*! Tetris - v0.1.0 - 2014-11-09
* https://github.com/Jinkwon/tetris.js
* Copyright (c) 2014 LeeJinKwon; Licensed MIT */
function meta(a,b){document.write('<meta name="'+a+'" content="'+b+'">')}var CordovaUtil=function(){function a(){"ANDROID"===device.platform.toUpperCase()?$(document).on("click",'a[href^="http"]',function(a){var b=$(this).attr("href");navigator.app.loadUrl(b,{openExternal:!0}),a.preventDefault()}):"IOS"===device.platform.toUpperCase()&&$(document).on("click",'a[href^="http"]',function(a){var b=$(this).attr("href");window.open(b,"_system"),a.preventDefault()})}var b=window.alert;window.alert=function(a,c,d){c=c?c:"Alert",d=d?d:"OK",navigator.notification?navigator.notification.alert(a,null,c,d):b(a)};var c=function(){window.device||(window.device={platform:"Browser"}),a()};c()};document.addEventListener("deviceready",function(){CordovaUtil.apply(this,arguments)},!1);var app=app?app:{};app.tetris=app.tetris?app.tetris:{},app.tetris.Game={},app.tetris.Board={},app.tetris.Menu={},app.tetris.Rules={},app.tetris.Util={},app.tetris.Account={},app.tetris.ui={},app.tetris.ui.Footer={},app.tetris.ui.Header={},app.tetris.ui.Option={},app.tetris.Network={},app.tetris.Credit={},app.tetris.Webgl={},app.tetris.config={sMode:"development",sHost:""},app.tetris.config.setEnv=function(a){app.tetris.config.sMode=a,app.tetris.config._refresh()},app.tetris.config._refresh=function(){var a="";switch(app.tetris.config.sMode){case"production":a="http://srv.bdyne.net:8080";break;case"staging":a="http://"+document.location.hostname+":8080";break;default:a="http://"+document.location.hostname+":8080"}app.tetris.config.sHost=a,app.tetris.config.sAccountUrl=a+"/account",app.tetris.config.sSessionUrl=a+"/session",app.tetris.config.sMonitorUrl=a+"/monitor",app.tetris.config.sGameUrl=a+"/game",app.tetris.config.sChatUrl=a+"/chat"},app.tetris.TemplateManager={templates:{},get:function(a,b){var c=this.templates[a];if(c){var d=_.template(c,b);return d}c=$.ajax({url:"./views/"+a+".html",async:!1}).responseText,this.templates[a]=c;var d=_.template(c,b);return d}},app.mobile={},app.mobile.metaInit=function(){meta("expires","-1"),meta("Cache-Control","No-Cache"),meta("Pragma","No-Cache"),meta("viewport","initial-scale=1.0, width=device-width, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"),meta("format-detection","address=no,telephone=no"),meta("apple-mobile-web-app-capable","yes"),meta("apple-mobile-web-app-status-bar-style","white"),meta("apple-touch-fullscreen","yes")},app.tetris.Network.init=function(){app.tetris.io||(app.tetris.io=io.connect(app.tetris.config.sHost,{timeout:1e4}),app.tetris.Game.Network.init(),app.tetris.Account.Network.init())},app.tetris.Network.startSession=function(){app.tetris.Network.oSessionIo=io.connect(app.tetris.config.sSessionUrl);var a=app.tetris.Network.oSessionIo;a.on("resConnectionCount",function(a){app.tetris.Network.Model.set({nConnectedUser:a.nConnectedUser,nRegisterUser:a.nRegisterUser})}),a.on("connect",function(){$("#selectable").empty(),a.emit("reqConnectionCount")})},function(){var a=Backbone.Model.extend({defaults:{nConnectedUser:0,nRegisterUser:0},initialize:function(){}});app.tetris.Network.Model=new a}(),app.tetris.Util.leadingSpaces=function(a,b){var c="";if(a=a.toString(),a.length<b)for(var d=0;d<b-a.length;d++)c+="0";return c+a},app.tetris.Util.getOrdinal=function(a){var b=["th","st","nd","rd"],c=a%100;return a+(b[(c-20)%10]||b[c]||b[0])},app.tetris.Util.makeGuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},app.tetris.Util.isMobile=function(){var a=!1;return function(b){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,4)))&&(a=!0)}(navigator.userAgent||navigator.vendor||window.opera),a},function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();var WebGLUtil={};WebGLUtil.createShader=function(a,b,c){var d=a.createShader(c);if(a.shaderSource(d,b),a.compileShader(d),!a.getShaderParameter(d,a.COMPILE_STATUS)){for(var e=a.getShaderInfoLog(d);e.length>1&&e.charCodeAt(e.length-1)<32;)e=e.substring(0,e.length-1);return alert(e),null}return d},WebGLUtil.loadImage=function(a,b,c){var d={};b.bIsLoaded=!1,d.img=new Image,d.img.src=c,d.img.onload=function(){a.bindTexture(a.TEXTURE_2D,b),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,d.img),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.generateMipmap(a.TEXTURE_2D),a.bindTexture(a.TEXTURE_2D,null),b.bIsLoaded=!0},d.img.onerror=function(){alert("error load texture")}},WebGLUtil.loadShader=function(a){var b=null;return $.ajax({async:!1,url:a,success:function(a){b=a},dataType:"text"}),b},app.tetris.ui.BackButton={setEvents:function(){this._hideDomWithContext=$.proxy(this._hideDom,this),this.welClose=$("#_container").find("._close"),this._sAniEvents="webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",$(document).on("click","._close",$.proxy(function(a){this._clearAnimationClass($(a.currentTarget)),$(a.currentTarget).addClass("bounceIn").show(),app.tetris.Router.moveBack()},this))},show:function(){this._clearAnimationClass(this.welClose),this.welClose.show().addClass("rotateIn"),this.welClose.off(this._sAniEvents)},_hideDom:function(){this.welClose.hide()},hide:function(){var a=$("#_container").find("._close");"none"!==a.css("display")?(this._clearAnimationClass(a),a.show().addClass("bounceOut").one(this._sAniEvents,this._hideDomWithContext)):(this._clearAnimationClass(a),a.hide())},_clearAnimationClass:function(a){a.removeClass("bounceIn").removeClass("rotateIn")}},function(){var a=Backbone.View.extend({el:"#_container #_footer",template:"ui/footer",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.render()},onClickMenu:function(){return!1},show:function(){return this.render(),this.$el.addClass("animated").addClass("fadeInDown").show(),this},hide:function(){this.$el.hide()},render:function(){var a=app.tetris.TemplateManager.get(this.template,{});return this.$el.html(a),this}});app.tetris.ui.Footer.View=new a}(),function(){var a="HEADER",b=Backbone.View.extend({el:"#_container #_header",template:"ui/header",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.sTitle=a,this.setEvents(),this.render()},setEvents:function(){this.model.bind("change",$.proxy(this.render,this))},onClickMenu:function(){return!1},show:function(){return this.render(),this.$el.addClass("animated").addClass("fadeInUp").show(),this},hide:function(){this.$el.hide(),this.sTitle=a},changeTitle:function(a){return this.sTitle=a,this},render:function(){var a={sTitle:this.sTitle,nConnectedUser:this.model.get("nConnectedUser")},b=app.tetris.TemplateManager.get(this.template,a);return this.$el.html(b),this}});app.tetris.ui.Header.View=new b({model:app.tetris.Network.Model})}(),app.tetris.ui.Option.View=Backbone.View.extend({el:"#_container #_option",template:"ui/option",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.render()},_setOptionListIdx:function(a){for(var b=0;b<a.length;b++)a[b].id=b;this.aOptionList=a},onClickMenu:function(a){this.unbind();var b,c=$(a.currentTarget).attr("data-idx");return this.aOptionList[c].fn&&(b=this.aOptionList[c].fn()),b!==!1&&this.hide(),!1},show:function(a){this._setOptionListIdx(a.aList||[]),this.sTitle=a.sTitle||"Options",this.$el.show(),this.showDimmedLayer(),this.render();var b=this.$el.find(".option_title").outerHeight()+this.$el.find(".option_layer").height();this.$el.find(".option_container").show().removeClass("animated flipInY").css("height",b+"px"),this.$el.find(".option_container").removeClass("animated flipInY").addClass("animated flipInY").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass("animated flipInY")})},hide:function(){var a=this;this.$el.find(".option_container").removeClass("animated05 fadeOutDown").addClass("animated05 fadeOutDown").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass("animated05 fadeOutDown"),a.$el.hide()}),this.hideDimmed()},hideDimmed:function(){$("#_dimmed_section").hide()},showDimmedLayer:function(a){return $("#_dimmed_section .pause").length>0?void $("#_dimmed_section").show():(a=a||"",$(".field .pause").remove(),void $("#_dimmed_section").html('<div class="pause" style="z-index:50;width:100%;height:100%;background-color:rgba(0,0,0,.7);position:absolute;color:#FFF;font-size:27px;font-family:Tahoma;"><div style="margin:auto;width:100%;height:25px;text-align:center;margin-top:200px;">'+a+"</div></div>").show())},render:function(){var a=app.tetris.TemplateManager.get(this.template,{aList:this.aOptionList,sTitle:this.sTitle});return this.$el.html(a),this}}),app.tetris.ui.Option.View=new app.tetris.ui.Option.View,function(){var a=function(){this.userId="",this.passwd="",this.bAvail=!1};a.prototype={_listeners:[],setAccount:function(a,b){this.userId=a,this.passwd=b},getAccount:function(){return{userId:this.userId,passwd:this.passwd}},on:function(a,b){return this.listeners=_.filter(this.listeners,function(b){return b.sEvent!==a}),this.listeners.push({fn:b,sEvent:a}),this},save:function(){""!==this.userId&&""!==this.passwd&&window.localStorage.setItem("account",JSON.stringify({userId:this.userId,passwd:this.passwd}))},load:function(){var a=window.localStorage.getItem("account"),b=JSON.parse(a)||{userId:"",passwd:""};this.userId=b.userId,this.passwd=b.passwd},clear:function(){window.localStorage.removeItem("account"),this.userId="",this.passwd="",this.bAvail=!1},broadcast:function(a){return _.each(this.listeners,function(b){b.sEvent===a&&b.fn()}),this},isAuthenticated:function(){return this.bAvail}},app.tetris.Account.Info=new a}(),app.tetris.Account.Network={},app.tetris.Account.Network.init=function(a){app.tetris.Account.Network.io||(app.tetris.Account.Network.io=app.tetris.io.of("/account"),app.tetris.Account.Network.io.on("connect",function(){a&&a()}).on("reconnect",function(){}).on("disconnect",function(){}).on("error",function(){alert("Cannot connect to Server","Server Error")}).on("reconnect_failed",function(){}).on("connect_failed",function(a){alert("Connect failed")}).on("resLogin",function(a){app.tetris.Account.Info.bAvail=a.bAvail,app.tetris.Account.Info.broadcast(app.tetris.Account.Info.bAvail?"onSuccessLogin":"onFailLogin")}).on("resJoin",function(a){return a.bAvail===!1?void alert(a.sMessage):(app.tetris.Account.Info.on("onSuccessLogin",function(){app.tetris.Account.Info.save(),app.tetris.Menu.View.render(),app.tetris.Router.navigate("menu",{trigger:!0})}),void app.tetris.Account.Network.io.emit("reqLogin",app.tetris.Account.Info.getAccount()))})),app.tetris.Account.Network.io.socket.connected===!1&&app.tetris.Account.Network.io.socket.connecting===!1?app.tetris.Account.Network.io.socket.connect():a&&a()},function(){var a=Backbone.View.extend({el:"#_container #_start_view",template:"start",events:{"click ._splash_section":"_onClickSplash","click ._join_btn":"_onClickJoin","click ._login_btn":"_onClickLogin"},initialize:function(){this.render()},assignElements:function(){this.welPw=this.$el.find("._pw"),this.welPwRe=this.$el.find("._pw_re"),this.welId=this.$el.find("._id")},_checkLoginValidation:function(){return""===this.welId.val().trim()?(alert("Please insert Id"),this.welId.focus(),!1):""===this.welPw.val().trim()?(alert("Please insert Password"),this.welPw.focus(),!1):!0},_checkJoinValidation:function(){return this._checkLoginValidation()?this.welPw.val()!==this.welPwRe.val()?(alert("Not same password"),!1):!0:!1},_onClickLogin:function(){this._checkLoginValidation()&&(this._updateAccount(),this._setAccountEvents(),app.tetris.Account.Network.io.emit("reqLogin",app.tetris.Account.Info.getAccount()))},_onClickJoin:function(){return"none"===this.welPwRe.css("display")?void this.welPwRe.show().css("height",0).animate({height:this.welPw.outerHeight()+"px"},250,"easeOutBounce"):void(this._checkJoinValidation()&&(this._updateAccount(),this._setAccountEvents(),app.tetris.Account.Network.io.emit("reqJoin",app.tetris.Account.Info.getAccount())))},_updateAccount:function(){var a=this.$el.find("._id").val(),b=this.$el.find("._pw").val();app.tetris.Account.Info.setAccount(a,b)},_setAccountEvents:function(){app.tetris.Account.Info.on("onFailLogin",function(){alert("Invalid Id or Password")}),app.tetris.Account.Info.on("onSuccessLogin",function(){app.tetris.Account.Info.save(),app.tetris.Router.navigate("menu",{trigger:!0})})},_onClickSplash:function(){return"none"!==this.$el.find("#_login_form").css("display")?void this._resetDisplay():(this.$el.find("._start_btn").removeClass("flipInY").addClass("fadeOutUp"),app.tetris.Account.Info.isAuthenticated()?app.tetris.Router.navigate("menu",{trigger:!0}):(this.hide(),this.$el.find("#_login_form").addClass("flipInX").show()),!1)},hide:function(){this.$el.find("._title").addClass("fadeOutUp").show()},_updateInputs:function(){var a=app.tetris.Account.Info.getAccount();this.$el.find("._id").val(a.userId),this.$el.find("._pw").val(a.passwd),this.$el.find("._pw_re").val(a.passwd),this.welPwRe.hide()},_playShowAnimation:function(){this.$el.find("._start_btn").removeClass("flipOutX").removeClass("flipOutY").addClass("flipInY"),this.$el.find("._title").removeClass("fadeOutUp").addClass("flipInX")},_hideLoginForm:function(){this.$el.find("#_login_form").hide()},_resetDisplay:function(){this._updateInputs(),this._hideLoginForm(),this._playShowAnimation()},show:function(){this._resetDisplay(),this.$el.show()},render:function(){var a=app.tetris.TemplateManager.get(this.template,{});return this.$el.html(a),this.assignElements(),this}});app.tetris.Account.View=new a}(),app.tetris.Board.init=function(a){if(!app.tetris.Board.bInitialized){var b=io.connect(app.tetris.config.sMonitorUrl),c=0,d=[],e=(navigator.userAgent.match(/(iPad|iPhone|iPod)/i)?!0:!1,function(){d=[],$("#_watch").empty(),$("#_gamePeople .ui-selected").each(function(){var a=$(this).attr("id").replace("_gp_",""),b=$(this).text();d.push(a);var c=[];c.push('<li class="other_user">'),c.push('<canvas id="_watch_'+a+'" width="100" height="210" class="other_user_canvas"></canvas>'),c.push('<div id="_info_'+a+'" class="info">'+b+"</div>"),c.push("</li>"),$("#_watch").append(c.join(""))}),b.emit("sendSelectedGamePeople",d)}),f=function(){b.on("resAdmin",function(a){"ok"===a?$("#_start").show():"game"===a&&$("#_stop").show()}),b.on("pushPeopleInfo",function(a){var b=a.aConnectedPeople||[],d=a.aGamePeople||[],f=b.length||0;c=d.length||0,this.bRealGame=a.bRealGame,$("#_currentConnectedPeople").text(f),$("#_currentGamePeople").text(c);for(var g=[],h=0;f>h;h++)g.push('<li id="_cp_'+b[h].sEmpNo+'">'+b[h].sEmpNm+"</li>");$("#_connectedPeople").html(g.join(""));for(var g=[],h=0;c>h;h++)this.bRealGame?(nScore=void 0===d[h].nScore?0:d[h].nScore,g.push('<li id="_gp_'+d[h].sEmpNo+'">'+d[h].sEmpNm+" - "+nScore+"점</li>")):g.push('<li id="_gp_'+d[h].sEmpNo+'">'+d[h].sEmpNm+"</li>");$("#_gamePeople").html(g.join("")).selectable({selected:function(){e()},stop:function(){e()}})}),b.on("pushGameInfo",function(a){$("#_info_"+a.sEmpNo).text(a.sEmpNm+" - "+a.nScore+"점")})},g=function(){$("#selectable").selectable(),f(),$("#_join").show(),$("#_start").on("click",function(){return 0===c?void alert("There is no ready people for gaming.\nTell people to be ready."):void(confirm("Do you really want to start the game?")&&($(this).hide(),$("#_stop").show(),b.emit("sendStart"),this.bRealGame=!0))}),$("#_stop").on("click",function(){$(this).hide(),$("#_start").show(),b.emit("sendStop")}),app.tetris.Board.bInitialized=!0};g()}},function(){var a=Backbone.View.extend({el:"#_container #_gameboard_view",template:"board",defaults:{oWebGLView:{},_bWebGLOn:!1},events:{"click._move_to_menu":"moveToMenu"},initialize:function(){this.render()},initNetwork:function(){if(app.tetris.io){var a=app.tetris.io.of("/game");a.emit("reqScoreBoard"),a.on("brScoreBoard",$.proxy(function(a){this.updateScoreDisplay(a.aScores)},this))}},updateScoreDisplay:function(a){var b=[];_.each(a,function(a,c){b.push("<li>"+(c+1)+". "+a.userId+": "+a.score)}),this.$el.find("._score_list").html(b.join(""))},show:function(){this.$el.hide().stop().fadeIn(300),this.initNetwork()},hide:function(){this.$el.hide()},moveToMenu:function(){app.tetris.Router.navigate("menu",{trigger:!0})},render:function(){var a={},b=app.tetris.TemplateManager.get(this.template,a);this.$el.html(b)}});app.tetris.Board.View=new a}(),function(){var a=Backbone.View.extend({el:"#_container #_credit_view",template:"credit",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.setEvents(),this.render()},setEvents:function(){},onClickMenu:function(){return!1},show:function(){this.$el.show(),this.$el.addClass("animated").removeClass("fadeInUp").addClass("fadeInDown")},hide:function(){this.$el.addClass("animated").removeClass("fadeInDown").addClass("fadeInUp")},render:function(){var a={},b=app.tetris.TemplateManager.get(this.template,a);return this.$el.html(b),this}});app.tetris.Credit.View=new a}(),app.tetris.Game.BlockModel=Backbone.Model.extend({defaults:function(){return{sColor:"",sCode:"",nAngle:0,aMatrix:[]}}}),app.tetris.Game.init=function(a){return void(a=a?a:{})},app.tetris.Game.Model=Backbone.Model.extend({defaults:function(){return{nScore:0,sGameStatus:"stop",nBlockPixel:null,aBlocks:null,nNumber:2,nCols:0,nRows:0,sUserId:"",sGuid:"",nLogicSpeed:1500,nLevel:1,aMatrix:[],nGameStartTime:0,oBlockCollection:{},htBlockPos:{nX:0,nY:0}}},initialize:function(){this.set({nScore:0,htBlockPos:{nX:5,nY:0},nLogicSpeed:1500,nLevel:1,aMatrix:[],sUserId:"",nRank:"",nCols:10,nRows:20,nBlockPixel:22}),this.set("sGuid",app.tetris.Util.makeGuid());var a=Backbone.Collection.extend({model:app.tetris.Game.BlockModel}),b=new a;b.add(app.tetris.Rules.BlockList.create()),this.set("oBlockCollection",b),this.initMatrix()},plusScore:function(a){var b=this.get("nScore");this.set("nScore",b+a)},clearFullLine:function(){for(var a,b,c,d=this.get("aMatrix"),e=this.get("nCols"),f=this.get("nRows"),g=0,h=0;f+2>h;h++){b=0;for(var i=1;e+1>i;i++)1==d[h][i].nFlag&&b++;if(b==e&&f+1>h){d.splice(h,1),c=[];for(var j=0;e+1>=j;j++)a=0===j||j===e+1?1:0,c.push({nFlag:a});d.unshift(c),g++}}return this.setMatrix(d),g},setBlockToMatrix:function(a,b){for(var c,d,e=a.get("aMatrix"),f=a.get("sColor"),g=this.getMatrix(),h=0;h<e.length;h++)for(var i=0;i<e[h].length;i++)c=i+b.nX,d=h+b.nY,void 0!==g[d]&&void 0!==g[d][c]&&1!==g[d][c].nFlag&&(g[d][c].nFlag=e[h][i],g[d][c].sColor=f);this.setMatrix(g)},setBlockPosXY:function(a,b){this.set("htBlockPos",{nX:a,nY:b})},getRandomRange:function(){var a=0,b=this.get("oBlockCollection").length-1;return Math.floor(Math.random()*(b-a+1)+a)},initMatrix:function(){for(var a=[],b=this.get("nCols"),c=this.get("nRows"),d=0;c+2>d;d++){a[d]=[];for(var e=0;b+2>e;e++)a[d][e]=0==e||e==b+1||d>c?{nFlag:1}:{nFlag:0}}this.setMatrix(a)},initVal:function(){this.initialize()},setMatrix:function(a){this.set("aMatrix",a)},getMatrix:function(){return this.get("aMatrix")}}),app.tetris.Game.Network={},app.tetris.Game.Network.close=function(){app.tetris.Game.Network.io&&app.tetris.Game.Network.io.disconnect()},app.tetris.Game.Network.open=function(){app.tetris.Game.Network.io&&app.tetris.Game.Network.io.reconnect()},app.tetris.Game.Network.init=function(){app.tetris.Game.Network.io=app.tetris.io.of("/game"),app.tetris.Game.Network.io.on("reconnect",function(){}).on("disconnected",function(){}).on("brGameStart",function(a){a.bIsStarted&&(app.tetris.Game.Network.sRoomName=a.sRoomName)}).on("brGameInfo",function(){}).on("resStartGame",function(a){400===a.code&&app.tetris.Game.Network.io.emit("reqRoomInfo",{sRoomId:a.sRoomId}),a.bIsStarted&&(app.tetris.Game.Network.sRoomName=a.sRoomName)}).on("brLeagueClosed",function(){})},function(){var a=Backbone.View.extend({el:"#_container #_single_view",template:"stage/stage.mobile",initialize:function(){this.render(),this._setViewProperties(),this._initTimer(),this.setUIEvents(),this.setLogicEvents()},setType:function(a){this._sType=a},_setViewProperties:function(){this.arColorPos={red:1,orange:2,yellow:3,green:4,sky:5,blue:6,purple:7,sand:8,leaf:9,brown:10,leaf2:11,sky2:12,sand2:13,stone:14},this._onTouchKeyPadWithContext=$.proxy(this._onTouchKeyPad,this),this._isDrawNextGroupBlock=!1,this._onBrRoomInfo=$.proxy(this._onChangeRoomData,this),this._onresQuickGame=$.proxy(function(a){this.setReady=!0,this._onChangeRoomData.apply(this,[a])},this),this._onChangeModel=$.proxy(function(){app.tetris.Game.Network.io.emit("brGameInfo",{sRoomId:this._sRoomId,aMatrix:this.model.get("aMatrix"),nScore:this.model.get("nScore")})},this),this._onGameStart=$.proxy(function(a){app.tetris.ui.Option.View.hide(),this._startNetworkGame(a)},this),this._onWisper=$.proxy(function(a){var b=this.$el.find("._score_board");if(a.nMyRank&&(b.find("._my_rank").html(app.tetris.Util.getOrdinal(a.nMyRank)).show(),a.nTotal)){var c=100/(a.nTotal-1)*(a.nMyRank-1);b.find("._rank_percent").css("left",c+"%").show()}var d=null;"im_back"===a.sType?d=this.backModel:"im_front"===a.sType&&(d=this.frontModel),d&&d.set({sUserId:a.sUserId,nRank:a.nRank,nScore:a.nScore,aMatrix:a.aMatrix})},this)},_startNetworkGame:function(a){this._sRoomId=a.sRoomId,this.model.unbind("change:nScore",this._onChangeModel),this.model.unbind("change:aMatrixCustomEvent",this._onChangeModel),this.model.bind("change:nScore",this._onChangeModel),this.model.bind("change:aMatrixCustomEvent",this._onChangeModel),this.startTimer(),this.oGameView.start(),app.tetris.Game.Network.io.emit("brGameInfo",{sRoomId:this._sRoomId,aMatrix:this.model.get("aMatrix"),nScore:this.model.get("nScore")})},_createMenuObject:function(a,b){return{sLabel:a,fn:b}},renderOtherStage:function(a,b){a.removeClass("pulse animated05").hide().addClass("pulse animated05").show();var c=b.get("nRank"),d=b.get("sUserId"),e=b.get("nScore");a.find("._rank").html(c>0?app.tetris.Util.getOrdinal(c):""),a.find("._text").html(""!==d?d+". "+e:"")},_onChangeRoomData:function(a){if(this.setReady&&"menu"!==a.sRoomId){app.tetris.Game.Network.io.removeListener("brGameStart",this._onGameStart),app.tetris.Game.Network.io.addListener("brGameStart",this._onGameStart),app.tetris.io.removeListener("brGameInfo",this._onWisper),app.tetris.io.addListener("brGameInfo",this._onWisper),this.backModel.bind("change:nScore change:aMatrix",$.proxy(function(){var a=$("._back_user_info");this.oBackGameView.drawMyStage(),this.renderOtherStage(a,this.backModel),this.backModel.get("sUserId")===this.frontModel.get("sUserId")&&this.frontModel.initVal()},this)),this.frontModel.bind("change:nScore change:aMatrix",$.proxy(function(){var a=$("._front_user_info");this.oFrontGameView.drawMyStage(),this.renderOtherStage(a,this.frontModel),this.backModel.get("sUserId")===this.frontModel.get("sUserId")&&this.backModel.initVal()},this));var b=[this._createMenuObject("Leave Room",$.proxy(function(){return this.setReady=!1,app.tetris.Game.Network.io.emit("unsubscribe",{sRoomId:a.sRoomId}),this.openMultiGameMenu(),!1},this)),this._createMenuObject("Go to Menu",$.proxy(function(){this.setReady=!1,app.tetris.Game.Network.io.emit("unsubscribe",{sRoomId:a.sRoomId}),app.tetris.Game.Network.io.emit("unsubscribe",{sRoomId:"menu"}),app.tetris.Router.navigate("menu",{trigger:!0})},this))];app.tetris.io.socket.sessionid===a.sOwnerId&&b.unshift(this._createMenuObject("Start Game",$.proxy(function(){return app.tetris.Game.Network.io.emit("reqStartGame",{sRoomId:a.sRoomId}),!1},this))),app.tetris.ui.Option.View.show({sTitle:"Multi Game<br> User : "+a.nMemberCount,aList:b})}},initNetworks:function(){app.tetris.Game.Network.io.emit("subscribe",{sRoomId:"menu"}),app.tetris.Game.Network.io.removeListener("resQuickGame",this._onresQuickGame),app.tetris.Game.Network.io.removeListener("brRoomInfo",this._onBrRoomInfo),app.tetris.Game.Network.io.addListener("resQuickGame",this._onresQuickGame),app.tetris.Game.Network.io.addListener("brRoomInfo",this._onBrRoomInfo)},openMultiQuickJoin:function(a){app.tetris.Game.Network.io.emit("unsubscribe",{sRoomId:"menu"}),this.initNetworks();var b=function(){return app.tetris.Game.Network.io.emit("reqQuickGame",{}),app.tetris.ui.Option.View.show(d),!1},c=function(){app.tetris.Game.Network.io.emit("unsubscribe",{sRoomId:"menu"}),app.tetris.Router.navigate("menu",{trigger:!0})},d={sTitle:a||"Multi Game",aList:[this._createMenuObject("Quick Join",$.proxy(b,this)),this._createMenuObject("Go to Menu",$.proxy(c,this))]};app.tetris.ui.Option.View.show(d),app.tetris.Game.Network.io.emit("reqQuickGame",{}),app.tetris.ui.Option.View.show(d)},openMultiGameMenu:function(a){this.initNetworks();var b=function(){return app.tetris.Game.Network.io.emit("reqQuickGame",{}),app.tetris.ui.Option.View.show(d),!1},c=function(){app.tetris.Game.Network.io.emit("unsubscribe",{sRoomId:"menu"}),app.tetris.Router.navigate("menu",{trigger:!0})},d={sTitle:a||"Multi Game",aList:[this._createMenuObject("Quick Join",$.proxy(b,this)),this._createMenuObject("Go to Menu",$.proxy(c,this))]};app.tetris.ui.Option.View.show(d)},_onTouchKeyPad:function(a){a.stopPropagation(),a.preventDefault();this.model.get("sGameStatus");if("play"!==this.model.get("sGameStatus"))return!1;if(a.handled!==!0){var b=$(a.currentTarget).attr("id");"down"===b?this.oGameView.moveDown(!0):"right"===b?this.oGameView.moveBlock("right"):"left"===b?this.oGameView.moveBlock("left"):"up"===b?this.oGameView.rotateBlock("right"):"harddown"===b&&this.oGameView.moveHardDown(),a.handled=!0}return!1},setLogicEvents:function(){app.tetris.Router.on("route",$.proxy(function(a){this.oGameView&&"moveToSingleGame"!==a&&"moveToMultiGame"!==a&&this.oGameView.stop().unbind()},this))},_renderScore:function(){var a=this.model.get("nScore"),b=this.$el.find(".score");b.empty().html(a),this.playUIAnimation(b.parent(),"pulse")},playUIAnimation:function(a,b,c){var d=".5"===c?"animated05":"animated",e="webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",f=function(){$(this).removeClass(d+" "+b)};a.removeClass(d+" "+b).addClass(d+" "+b).one(e,f)},onBlockChange:function(){this.drawNextBlock()},drawNextBlock:function(){var a=this.model.get("oBlockCollection"),b=this.model.get("nextBlock")[0];if(a.at(b)){var c=this.getBlockString(a.at(b).get("aMatrix"),a.at(b).get("sColor"),16,"next");if($(".next_block_container").empty().append(c),this._isDrawNextGroupBlock){$(".next_group_block_container").empty();for(var d=0;3>d;d++)b=this.model.get("nextBlock")[d+1],c=this.getBlockString(a.at(b).get("aMatrix"),a.at(b).get("sColor"),12,"next_"+d),$(".next_group_block_container").append(c+'<div style="clear:both;height:43px;"></div>')}this.playUIAnimation($("._next_block"),"fadeInDown")}},getPosPixelByColor:function(a,b){return this.arColorPos[a]*b},getBlockString:function(a,b,c,d){for(var e,f=['<div class="single_block" style="clear:both;" id="'+d+'">'],g=0;g<a.length;g++){for(var h=0;h<a[g].length;h++)1==a[g][h]?(e=this.getPosPixelByColor(b,c),f.push('<div class="fill_block_'+c+'" style="width:'+c+"px;height:"+c+"px;background-position:-"+e+'px 0;"></div>')):f.push('<div class="empty_block" style="width:'+c+"px;height:"+c+'px;"></div>');f.push('<div class="clear"></div>')}return f.push("</div><br>"),f.join("")},resetUI:function(){"multi"===this._sType?this.$el.find("._multi").show():this.$el.find("._multi").hide()},render:function(){var a=app.tetris.TemplateManager.get(this.template,{});return this.$el.html(a),this.resetUI(),this},clearOldViewObject:function(){this.oGameView&&this.oGameView.unbind(),this.oGameView2&&this.oGameView2.unbind(),this.oGameView3&&this.oGameView3.unbind()},show:function(){this.oGameView&&this.oGameView.stop().unbind(),this.resetUI(),this.$el.show(),this.clearOldViewObject(),this.initGame(),this._renderScore(),this.playUIAnimation(this.$el.find("._option"),"rotateIn")},setGameEvents:function(){this.$el.off("touchstart mousedown",".jpad",this._onTouchKeyPadWithContext).on("touchstart mousedown",".jpad",this._onTouchKeyPadWithContext)},bindModelEvents:function(){this.model.bind("change:sGameStatus",this.watchGameStatus,this),this.model.bind("change:htBlockPos",this.onBlockChange,this),this.model.bind("change:nScore",this._renderScore,this)},getGameType:function(){return this._sType},isMultiGame:function(){return"multi"===this.getGameType()},initGame:function(){this.model=new app.tetris.Game.Model,this.bindModelEvents(),this.oGameView=new app.tetris.Game.View({el:"#single_game_area",model:this.model,bKeyEventBind:!0,bUseSound:!0}),this.setGameEvents(),this.isMultiGame()?this.openMultiGameMenu():(this.startTimer(),this.oGameView.start()),this.frontModel=new app.tetris.Game.Model,this.oFrontGameView=new app.tetris.Game.View({el:"#other_1_game_area",model:this.frontModel,bUseWebGL:!1,bUseSound:!1}),this.backModel=new app.tetris.Game.Model,this.oBackGameView=new app.tetris.Game.View({el:"#other_2_game_area",model:this.backModel,bUseWebGL:!1});var a=$(this.$el);this._setGameEvents(a)},runTick:function(){var a=this.nGameStartTime;a+=1e3;var b=new Date(a),c=app.tetris.Util.leadingSpaces(b.getMinutes(),2),d=app.tetris.Util.leadingSpaces(b.getSeconds(),2);this.drawTime(c,d),this.nGameStartTime=a,this.model.set("nGameStartTime",a)},drawTime:function(a,b){var c=this.$el.find("._play_time");c.html(a+":"+b),this.playUIAnimation(c,"rubberBand",".5")},_initTimer:function(){this.drawTime("00","00"),this.stopTimer()},startTimer:function(){var a=this;this.nGameStartTime=this.model.get("nGameStartTime"),this.stopTimer(),this.runTick(),this.timer=setInterval(function(){a.runTick()},1e3)},stopTimer:function(){clearTimeout(this.timer)},watchGameStatus:function(){var a=this.model.get("sGameStatus");
"start"===a||("play"===a?($(".field .pause").remove(),this.startTimer()):"pause"===a?this.stopTimer():"stop"===a?(this._initTimer(),this.openDimmedLayer("Hello TETRIS")):"ready"===a?this.openDimmedLayer("Ready"):"game"===a?this.openDimmedLayer("Already Started"):"end"===a?(this.stopTimer(),this.openDimmedLayer(),this.openGameMenu("Game Over")):this.stopTimer())},logChat:function(a){var b=$(".chat_area").html();$(".chat_area").html(b+a+"<br>"),$(".chat_area").scrollTop($(".chat_area")[0].scrollHeight)},_setGameEvents:function(a){a.find("#start_btn").on("click",$.proxy(this.oGameView.start,this.oGameView)),a.find("#stop_btn").on("click",$.proxy(this.oGameView.stop,this.oGameView)),a.find("#ready_btn").on("click",$.proxy(this.oGameView.reqReady,this.oGameView)),a.find("#cancel_btn").on("click",$.proxy(this.oGameView.reqCancel,this.oGameView)),a.find("#start_touch").on("click",$.proxy(this.oGameView.start,this.oGameView)),a.find("#debug_btn").on("click",$.proxy(this.oGameView.debugStart,this.oGameView))},setUIEvents:function(){var a=this.$el;a.find("#ssamdi").on("click",$.proxy(function(){this._bWebGLOn=this._bWebGLOn===!0?!1:!0},this.oGameView)),a.find("#fullscreen_btn").bind("click",function(){var a=document.documentElement,b=a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen;b.call(a)}),a.find("#fullscreen_btn").bind("click",$.proxy(this._onClickFullScreen,this)),this.$el.on("click","._option",$.proxy(function(){this.openOptionMenu()},this))},openOptionMenu:function(){var a=function(){var a=[{sLabel:"Back",fn:$.proxy(this.openOptionMenu,this)}];return app.tetris.Game.Util.isWebGLAvailable()&&a.unshift({sLabel:"Use WebGL",fn:$.proxy(function(){this.oGameView&&this.oGameView.useWebGL(!0)},this)}),app.tetris.ui.Option.View.show({sTitle:"Setting",aList:a}),!1},b=function(){app.tetris.Router.navigate("menu",{trigger:!0})},c=function(){return this.oGameView.pause(),app.tetris.ui.Option.View.show({sTitle:"Pause",aList:[{sLabel:"Continue",fn:$.proxy(function(){this.startTimer(),this.oGameView.pause()},this)}]}),!1},d=function(){return app.tetris.Router.navigate("menu",{trigger:!0}),app.tetris.Router.navigate("multi",{trigger:!0}),!1},e=function(){this.oGameView.start()},f=[];return f=this.isMultiGame()?[{sLabel:"Continue"},{sLabel:"Pause",fn:$.proxy(c,this)},{sLabel:"Restart",fn:$.proxy(e,this)},{sLabel:"Re-join Multi Game",fn:$.proxy(d,this)},{sLabel:"Setting",fn:$.proxy(a,this)},{sLabel:"Exit Multi Game",fn:$.proxy(b,this)}]:[{sLabel:"Continue"},{sLabel:"Restart",fn:$.proxy(e,this)},{sLabel:"Pause",fn:$.proxy(c,this)},{sLabel:"Join Multi Game",fn:$.proxy(d,this)},{sLabel:"Setting",fn:$.proxy(a,this)},{sLabel:"Go to Menu",fn:$.proxy(b,this)}],app.tetris.ui.Option.View.show({aList:f}),!1},openGameMenu:function(a){var b=function(){this.oGameView.start()},c=function(){return app.tetris.Router.navigate("menu",{trigger:!0}),app.tetris.Router.navigate("multi",{trigger:!0}),!1},d=function(){app.tetris.Router.navigate("menu",{trigger:!0})},e=[];e=this.isMultiGame()?[{sLabel:"Re-Join Multi Game",fn:$.proxy(c,this)},{sLabel:"Go to Menu",fn:$.proxy(d,this)}]:[{sLabel:"Replay Game",fn:$.proxy(b,this)},{sLabel:"Join Multi Game",fn:$.proxy(c,this)},{sLabel:"Go to Menu",fn:$.proxy(d,this)}],app.tetris.ui.Option.View.show({sTitle:a||"",aList:e})},_onClickFullScreen:function(){if(1==that.bFullScreen)that.bFullScreen=!1;else{var a=document.documentElement,b=a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen;b.call(a),that.bFullScreen=!0}},openDimmedLayer:function(a){a=a||"",$(".field .pause").remove(),$("#_dimmed_section").html('<div class="pause" style="z-index:50;width:100%;height:100%;background-color:rgba(0,0,0,.7);position:absolute;color:#FFF;font-size:27px;font-family:Tahoma;"><div style="margin:auto;width:100%;height:25px;text-align:center;margin-top:200px;">'+a+"</div></div>").show()}});app.tetris.Game.StageView={_oInstance:null,getInstance:function(){return null===this._oInstance&&(this._oInstance=new a),this._oInstance}}}(),app.tetris.Game.Util={isWebGLAvailable:function(){var a=document.createElement("canvas"),b=["webgl","experimental-webgl","webkit-3d","moz-webgl"];this.ctx=null;for(var c=0;c<b.length;++c){try{this.ctx=a.getContext(b[c])}catch(d){break}if(null!==this.ctx)break}return null!==this.ctx},isCollision:function(a,b,c,d){for(var e,f,g=!1,h=b.get("aMatrix"),i=0;i<h.length;i++)for(var j=0;j<h[i].length;j++)if(e=j+a.nX,f=i+a.nY,"bottom"===d?f+=1:("left"===d||"right"===d)&&(e="left"===d?e-1:e+1),void 0!==c[f]&&void 0!==c[f][e]&&1===c[f][e].nFlag&&1===h[i][j]){g=!0;break}return g},rotateBlockArray:function(a,b,c,d){var e,f=b.get("aMatrix"),g=b.get("sCode"),h=b.get("nAngle"),i=[],k=!1;if("O"!==g&&(k=!0),("S"===g||"I"===g||"Z"===g)&&h>0&&(a="left"),k===!0){if("right"===a)for(h=(h+90)%360,j=f[0].length-1;j>=0;j--){for(e=[],e.push(f[3][j]),l=0;l<f.length-1;l++)e.push(f[l][j]);i.push(e)}else{for(h=(h-90)%360,j=1;j<f.length;j++){for(e=[],l=f[0].length-1;l>=0;l--)e.push(f[l][j]);i.push(e)}e=[];for(var l=f[0].length-1;l>=0;l--)e.push(f[l][0]);i.push(e)}var m=b.clone().set("aMatrix",i);this.isCollision(c,m,d)||b.set({aMatrix:i,nAngle:h})}return b}},app.tetris.Game.View=Backbone.View.extend({defaults:{oWebGLView:{},_bWebGLOn:!1},initialize:function(a){this.assignProperties(a),this.render(),this.initResources(),this.resetData(),this.useWebGL(this._bWebGLOn),this.initCanvas(),this._bKeyEventBind&&this.bindEvents(),this.drawMyStage()},assignProperties:function(a){this.Util=app.tetris.Game.Util,this.oUIView=a.oUIView,this._bKeyEventBind=a.bKeyEventBind||!1,this._bUseSound=a.bUseSound||!1,this._bWebGLOn=a.bUseWebGL||!1,this._fnKeyEvent=$.proxy(this._onKeyAction,this)},render:function(){var a=['<canvas class="_tetris_webgl_canvas web_gl_cvs" style="width:100%;height:100%;"></canvas>','<canvas class="_tetris_origin_canvas org_cvs" style="width:100%;height:100%;"> </canvas>'];this.$el.html(a.join(""))},resetData:function(){this.nTickCnt=0,this.tickTime=35,this.nLogicTickCnt=0,this.nLongPressCnt=0,this.level=1,this.model.set("nGameStartTime",0),this.model.set("nScore",0),this.initMatrix()},initResources:function(){this.blockImg=[],this.blockImg[22]=new Image,this.blockImg[22].src="./res/img/mino_main.png",this.blockImg[10]=new Image,this.blockImg[10].src="./res/img/mino_sub.png",this.arColorPos={red:1,orange:2,yellow:3,green:4,sky:5,blue:6,purple:7,sand:8,leaf:9,brown:10,leaf2:11,sky2:12,sand2:13,stone:14},this.initAudio()},initAudio:function(){this.htSound={},this._bUseSound&&(this.htSound={harddrop:new Howl({urls:["./res/sound/TE_SE_harddrop.mp3"],volume:.3}),softdrop:new Howl({urls:["./res/sound/TE_SE_softdrop.mp3"],volume:.3}),lockdown:new Howl({urls:["./res/sound/TE_SE_lockdown.mp3"],volume:.3})},document.addEventListener("deviceready",$.proxy(function(){this.htSound={harddrop:new Media("./res/sound/TE_SE_harddrop.mp3",null,null),softdrop:new Media("./res/sound/TE_SE_softdrop.mp3",null,null),lockdown:new Media("./res/sound/TE_SE_lockdown.mp3",null,null)}},this),!1))},disableSmoothing:function(){this.stage.ctx.imageSmoothingEnabled=!1,this.stage.ctx.webkitImageSmoothingEnabled=!1,this.stage.ctx.mozImageSmoothingEnabled=!1},assignCanvasSize:function(){this.nWidth=$(this.stage.elCanvas).width(),this.nHeight=$(this.stage.elCanvas).height(),this.stage.nWidth=this.nWidth,this.stage.nHeight=this.nHeight,$(this.stage.elCanvas).attr("width",this.nWidth).attr("height",this.nHeight)},initCanvas:function(){this.stage=this.getOriginCanvasObject(),this.assignCanvasSize(),this._bWebGLOn?($(this.stage.elCanvas).hide(),this.$el.find("._tetris_webgl_canvas").show(),this._bWebGLOn=this.oWebGLView.isAvailWebGL(),this._bWebGLOn&&this.oWebGLView.initCanvas()):(this.$el.find("._tetris_webgl_canvas").hide(),$(this.stage.elCanvas).show()),this.disableSmoothing()},controlSound:function(a,b){return this.htSound[a]&&this._bUseSound?void("play"===b?this.htSound[a].play():"stop"===b&&this.htSound[a].pause()):!1},bindEvents:function(){var a=this;$(window).on("resize",function(){a.initCanvas()})},drawGhostBlock:function(){for(var a=this.model.get("htBlockPos"),b=0,c=0;35>c;c++)if(b=a.nY+c,this.Util.isCollision({nX:a.nX,nY:a.nY+c},this.model.get("currentBlock"),this.model.get("aMatrix"),"bottom")){this.drawMovingBlock(this.model.get("currentBlock"),{nX:a.nX,nY:b},!0);break}},drawMovingBlock:function(a,b,c){b=b||this.model.get("htBlockPos");var d,e,f,g=a?a.get("aMatrix"):this.model.get("currentBlock").get("aMatrix"),h=a?a.get("sColor"):this.model.get("currentBlock").get("sColor"),i=this.stage;if(void 0!==g)for(var j=0;j<g.length;j++)for(var k=0;k<g[j].length;k++)f=!1,1===g[j][k]&&(f=!0),this.debugMode&&f===!1&&(h="stone",f=!0),f&&(d=k+b.nX-1,e=j+b.nY,this.drawBlock(i.ctx,h,i.nBlockSize,d,e,c?.2:1))},drawMyStage:function(){this.drawStage(this.stage,this.getMatrix()),this.debugMode&&this.drawDebugStage()},drawStage:function(a,b,c){if(0!==b.length){var d=b.length,e=b[0].length,f=a.ctx,g=a.nBlockSize;this.clearScreen(a);for(var h=0;d>h;h++)for(var i=0;e>i;i++)if(1===b[h][i].nFlag){var j=b[h][i].sColor;this.drawBlock(f,j,g,i-1,h,1,c)}}},drawToWebGL:function(a,b,c,d,e){var f=this.getMatrix(),g=f.length,h=f[0].length,i=(h-1)*a/2-10,j=(g+1)/2*a,k=-50;this.oWebGLView.bCameraPerspective=!0,this.oWebGLView.arCameraLookAt=[i,j,k],this.oWebGLView.drawBlock(b,g-c,a,this.arColorPos[d],[1,1,1,e])},drawToCanvas:function(a,b,c,d,e,f){var g=this.stage.ctx;void 0===f&&(f=this.stage.nHeight/20);var h=this.getPosPixelByColor(d,a);g.globalAlpha=e;var i=this.stage.nWidth/10,j=this.stage.nHeight/20;g.drawImage(this.blockImg[a],h,0,a,a,b*i,c*j-f,i,j),g.globalAlpha=1},drawBlock:function(a,b,c,d,e,f,g){if(void 0===b||void 0===a)return!1;var h=this._bWebGLOn;this.ctx&&a==this.stage.ctx&&void 0!==this.oWebGLView&&(h=this._bWebGLOn===!0?!0:!1),h?this.drawToWebGL(c,d,e,b,f):this.drawToCanvas(c,d,e,b,f,g)},clearScreen:function(a){return a.ctx.clearRect(0,0,a.nWidth,a.nHeight),void 0===this.ctx?null:void(a.ctx==this.stage.ctx&&void 0!==this.oWebGLView&&this._bWebGLOn&&this.oWebGLView.clear())},getOriginCanvasObject:function(){return this.getCanvasObjectBy("canvas")},getCanvasObjectBy:function(a){var b=null;switch(a){case"canvas":b=this.$el.find("._tetris_origin_canvas")[0]}var c=$(b).hasClass("game_area")?this.model.get("nBlockPixel"):10;return null===b?!1:{elCanvas:b,ctx:b.getContext("2d"),nWidth:b.width,nHeight:b.height,nBlockSize:c}},setGameStatus:function(a){this.model.set("sGameStatus",a),"start"===a&&(this.debugMode=!1,$("#debug_area").empty().hide(),$(".pause").remove())},bindKeyEvents:function(){this.htKeyState={},$(document).off("keydown keyup",this._fnKeyEvent).on("keydown keyup",this._fnKeyEvent)},getGameStatus:function(){return this.model.get("sGameStatus")},checkLevelUp:function(){app.tetris.Rules.filterRules(this.model.get("nScore"),$.proxy(function(a){this.model.set("nLogicSpeed",a.nLogicSpeed),this.model.set("nLevel",a.nLevel)},this))},useWebGL:function(a){this._bWebGLOn=a,this.oWebGLView||(this.oWebGLView=new app.tetris.Game.WebGLView({el:this.$el.find("._tetris_webgl_canvas")})),this.initCanvas()},renderCanvas:function(){this.drawMyStage(),this.drawMovingBlock(),this.drawGhostBlock()},tick:function(){this.checkLevelUp(),this.renderCanvas(),this.nTickCnt+=this.tickTime,this.nLogicTickCnt+=this.tickTime;var a=this.model.get("nLogicSpeed");this.nLogicTickCnt>a&&(this.setGameStatus("play"),this.moveDown(!0),this.nLogicTickCnt-=a),1==this.keyPressFlag&&(this.htKeyState[37]?this.moveBlock("left"):this.htKeyState[39]&&this.moveBlock("right"))},start:function(a){if("start"!==this.getGameStatus()){var b=$(this.el);a?(b.find("#start_btn").hide(),b.find("#stop_btn").hide(),b.find("#cancel_btn").hide()):(b.find("#start_btn").hide(),b.find("#stop_btn").show()),this.resetData(),this.setGameStatus("start"),this.model.set("nextBlock",[]);for(var c=0;5>=c;c++){var d=this.model.get("nextBlock");d.push(this.model.getRandomRange()),this.model.set("nextBlock",d)}this.makeNewBlock(),this.stopAnimationLoop(),this.startAnimationLoop(),this.tick(),this._bKeyEventBind&&(clearTimeout(this.keyLongPressChecker),this.bindKeyEvents())}},stopAnimationLoop:function(){cancelAnimationFrame(this.ticker)},startAnimationLoop:function(){this.ticker=requestAnimationFrame($.proxy(this.startAnimationLoop,this)),this.tick()},debugStart:function(){if("start"!==this.getGameStatus()){$(".pause").remove(),this.debugMode=!0,this.setGameStatus("debug"),this.resetData(),this.model.set("nextBlock",[]);for(var a=0;5>=a;a++){var b=this.model.get("nextBlock");b.push(this.model.getRandomRange()),this.model.set("nextBlock",b)}this.makeNewBlock(),this.bindKeyEvents(),this.drawMyStage()}},pause:function(){"pause"===this.model.get("sGameStatus")?($(document).off("keydown",this._fnKeyEvent),this.setGameStatus("play"),this.startAnimationLoop()):(this.stopAnimationLoop(),this.setGameStatus("pause"),this._bKeyEventBind&&this.bindKeyEvents())},stop:function(){return this.setGameStatus("stop"),$(".pause").remove(),clearTimeout(this.keyLongPressChecker),cancelAnimationFrame(this.ticker),$(this.el).find("#active").remove(),this.initMatrix(),this.drawMyStage(),this.resetData(),$("#debug_area").empty().hide(),$(document).off("keydown",this._fnKeyEvent),this},makeNewBlock:function(){var a=this.model.get("oBlockCollection"),b=this.model.get("nextBlock").shift();if(this.isGameOver())return!1;this.model.set("nextBlock",[]);var c=this.model.get("nextBlock");c.push(this.model.getRandomRange()),this.model.set("currentBlock",a.at(b).clone()),this.model.setBlockPosXY(4,-1)},moveDown:function(a){if(!this.checkGameOver()){var b=this.model.get("htBlockPos"),c=!1,d=this.Util.isCollision(b,this.model.get("currentBlock"),this.model.get("aMatrix"),"bottom");return d?(a&&this.controlSound("lockdown","play"),this.model.trigger("change:aMatrixCustomEvent"),this.model.setBlockToMatrix(this.model.get("currentBlock"),this.model.get("htBlockPos")),this.makeNewBlock(),c=!0):(b.nY++,this.model.set("htBlockPos",b)),this.clearFullLine(),this.debugMode&&(this.drawMyStage(),this.drawMovingBlock()),c}},clearFullLine:function(){var a=this.model.clearFullLine();this._addScoreBy(a)},_addScoreBy:function(a){if(a>0){var b=0;this._nHardBlockPosY<=2&&(b=50*(this._nHardBlockPosY+1)),this.model.plusScore(100*a+b)}},moveBlock:function(a){var b=this.model.get("htBlockPos"),c=this.Util.isCollision(this.model.get("htBlockPos"),this.model.get("currentBlock"),this.model.get("aMatrix"),a);"left"!==a||c?"right"!==a||c||(b.nX++,this.model.set("htBlockPos",b)):(b.nX--,this.model.set("htBlockPos",b)),this.debugMode&&(this.drawMyStage(),this.drawMovingBlock())},setMatrix:function(a){this.model.setMatrix(a)},getMatrix:function(){return this.model.get("aMatrix")},initMatrix:function(){this.model.initMatrix()},getPosPixelByColor:function(a,b){return this.arColorPos[a]*b},rotateBlock:function(a){var b=this.Util.rotateBlockArray(a,this.model.get("currentBlock"),this.model.get("htBlockPos"),this.model.get("aMatrix"));this.model.set("currentBlock",b),this.debugMode&&(this.drawMyStage(),this.drawMovingBlock())},isGameOver:function(){for(var a=this.getMatrix(),b=0,c=this.model.get("nCols")+1,d=1;c>d;d++)1==a[0][d].nFlag&&b++;return b>0},checkGameOver:function(){return this.isGameOver()?($(this.el).find("#active").remove(),this.stopAnimationLoop(),this.setGameStatus("end"),$(document).off("keydown",this._fnKeyEvent),!0):!1},clearLongPress:function(){clearInterval(this.keyLongPressChecker),this.nLongPressCnt=0},resetBlockPos:function(a){a=this.model.get("htBlockPos"),a.nY=-1,this.model.set("htBlockPos",a)},playBoundEffect:function(){this._bWebGLOn||this.$el.removeClass("bounceDrops animatedDrops").addClass("bounceDrops animatedDrops").show().one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass("bounceDrops animatedDrops")})},moveHardDown:function(){this.clearLongPress(),this.playBoundEffect(),this.controlSound("harddrop","play");var a=!1;this._nHardBlockPosY=this.model.get("htBlockPos").nY;for(var b=0,c=this.model.get("nRows");c>b;b++){if(a===!0){this.resetBlockPos(),this.model.trigger("change:aMatrixCustomEvent");break}var d=!1;a=this.moveDown(d)}},_onKeyAction:function(a){var b=a.keyCode;if("keydown"==a.type&&0===this.nLongPressCnt&&(this.htKeyState[a.keyCode||a.which]=!0,this.nLongPressCnt=1,clearInterval(this.keyLongPressChecker)),"keyup"==a.type&&(this.htKeyState[a.keyCode||a.which]=!1,this.nLongPressCnt=0,clearInterval(this.keyLongPressChecker)),"keyup"===a.type)return!1;if("pause"===this.model.get("sGameStatus")&&16!==b)return!1;switch(b){case 32:this.moveHardDown();break;case 37:this.moveBlock("left");break;case 39:this.moveBlock("right");break;case 38:this.rotateBlock("right");break;case 40:this.moveDown(!0);break;case 90:this.rotateBlock("left");break;case 88:this.rotateBlock("right")}return!1},drawDebugStage:function(){for(var a=this.getMatrix(),b=[],c=a.length,d=a[0].length,e=0;c>e;e++){for(var f=0;d>f;f++)b.push('<div class="block">'+a[e][f].nFlag+"</div>");b.push('<div class="clear"></div>')}$("#debug_area").show().empty().append(b.join(""))}}),app.tetris.Game.WebGLView=Backbone.View.extend({defaults:{nWidth:0,nHeight:0,arCameraEye:[0,0,0],arCameraLookAt:[0,0,0],fAngleYZ:100,fAngleXZ:0,fCameraDistance:0,bCameraPerspective:!1,nFov:0,ctx:null,bWebGLAvailable:!1},initialize:function(){this.vertexShaderText=WebGLUtil.loadShader("res/shader/model.vs"),this.fragmentShaderText=WebGLUtil.loadShader("res/shader/model.fs")},isAvailWebGL:function(){return!!window.WebGLRenderingContext},initCanvas:function(){var a=this.$el[0];this.nWidth=this.$el.parent().width(),this.nHeight=this.$el.parent().height(),this.$el.attr("width",this.nWidth),this.$el.attr("height",this.nHeight),this.arCameraEye=[0,0,0],this.arCameraLookAt=[0,0,0],this.fAngleYZ=0,this.fAngleXZ=Math.PI/2,this.fCameraDistance=300,this.bCameraPerspective=!1,this.nFov=45;var b=["webgl","experimental-webgl","webkit-3d","moz-webgl"];this.ctx=null;for(var c=0;c<b.length;++c){try{this.ctx=a.getContext(b[c])}catch(d){break}if(null!=this.ctx)break}this.bWebGLAvailable=null==this.ctx?!1:!0,this.initResource(),this.initShader(),this.clear(),this.setEvents()},setEvents:function(){var a=this;this.forward=!1,this.startX=0,this._nMovedViewX=0,this._nMovedViewY=0;var b=function(a){if(this.mouseDownFlag){var b=c.width(),d=c.offset().left,e=c.offset().top,f=c.height();a=a.originalEvent.changedTouches?a.originalEvent.changedTouches[0]:a.originalEvent;var g=a.clientX-d-this._nMovedViewX,h=a.clientY-e-this._nMovedViewY,i=g/b*180;this.fAngleXZ=i*Math.PI/180,i=h/f*90,this.fAngleYZ=i*Math.PI/180,this._nViewX=g,this._nViewY=h}};this.flag=0,this.startX=350;var c=this.$el;c.mousewheel(function(b,c){return a.fCameraDistance+=10*c,!1});var d=$.proxy(b,this);c.on("mousedown touchstart",function(){a.mouseDownFlag=!0,$(document).on("touchmove mousemove",d)}),$(document).on("mouseup touchcancel touchend",$.proxy(function(){this.mouseDownFlag=!1,$(document).off("mousemove touchmove",d)},this))},initResource:function(){var a=this.ctx,b=[-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5];this.gl_VB_Position_Cube=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.gl_VB_Position_Cube),a.bufferData(a.ARRAY_BUFFER,new Float32Array(b),a.STATIC_DRAW),this.gl_VB_Position_Cube.itemSize=3,this.gl_VB_Position_Cube.numItems=24,a.bindBuffer(a.ARRAY_BUFFER,null);var c=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];this.gl_VB_Color_Cube=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.gl_VB_Color_Cube),a.bufferData(a.ARRAY_BUFFER,new Float32Array(c),a.STATIC_DRAW),this.gl_VB_Color_Cube.itemSize=4,this.gl_VB_Color_Cube.numItems=24,a.bindBuffer(a.ARRAY_BUFFER,null);var d=[0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1];this.gl_VB_Cordinate_Cube=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.gl_VB_Cordinate_Cube),a.bufferData(a.ARRAY_BUFFER,new Float32Array(d),a.STATIC_DRAW),this.gl_VB_Cordinate_Cube.itemSize=2,this.gl_VB_Cordinate_Cube.numItems=24,a.bindBuffer(a.ARRAY_BUFFER,null);var e=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];this.gl_IB_Cube=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.gl_IB_Cube),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),a.STATIC_DRAW),this.gl_IB_Cube.itemSize=1,this.gl_IB_Cube.numItems=36,a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),this.gl_Tex_Cube=a.createTexture(),WebGLUtil.loadImage(a,this.gl_Tex_Cube,"res/img/mino_main2.png")},initShader:function(){var a=this.ctx;this.gl_Shader_RenderProgram=a.createProgram();var b=this.vertexShaderText,c=WebGLUtil.createShader(a,b,a.VERTEX_SHADER),d=this.fragmentShaderText,e=WebGLUtil.createShader(a,d,a.FRAGMENT_SHADER);return null==c||null==e?(alert("Shader can not compile"),!1):(a.attachShader(this.gl_Shader_RenderProgram,c),a.attachShader(this.gl_Shader_RenderProgram,e),a.deleteShader(c),a.deleteShader(e),a.linkProgram(this.gl_Shader_RenderProgram),a.getProgramParameter(this.gl_Shader_RenderProgram,a.LINK_STATUS)?(a.useProgram(this.gl_Shader_RenderProgram),this.gl_Attribute_VertexPosition=a.getAttribLocation(this.gl_Shader_RenderProgram,"aVertexPosition"),this.gl_Attribute_VertexColor=a.getAttribLocation(this.gl_Shader_RenderProgram,"aVertexColor"),this.gl_Attribute_VertexCordinate=a.getAttribLocation(this.gl_Shader_RenderProgram,"aVertexCordinate"),this.gl_Uniform_WorldMatrix=a.getUniformLocation(this.gl_Shader_RenderProgram,"uWorldMatrix"),this.gl_Uniform_ViewMatrix=a.getUniformLocation(this.gl_Shader_RenderProgram,"uViewMatrix"),this.gl_Uniform_ProjectionMatrix=a.getUniformLocation(this.gl_Shader_RenderProgram,"uProjectionMatrix"),this.gl_Uniform_Texture=a.getUniformLocation(this.gl_Shader_RenderProgram,"uTexture"),this.gl_Uniform_ModulateCordinate=a.getUniformLocation(this.gl_Shader_RenderProgram,"uModulateCordinate"),this.gl_Uniform_Color=a.getUniformLocation(this.gl_Shader_RenderProgram,"uColor"),void a.useProgram(null)):(alert("Could not initialize shaders"),!1))},drawBlock:function(a,b,c,d,e){var f=this.ctx;f.useProgram(this.gl_Shader_RenderProgram),f.enableVertexAttribArray(this.gl_Attribute_VertexPosition),f.enableVertexAttribArray(this.gl_Attribute_VertexColor),f.enableVertexAttribArray(this.gl_Attribute_VertexCordinate);var g=[this.fCameraDistance*Math.cos(this.fAngleYZ)*Math.cos(this.fAngleXZ),this.fCameraDistance*Math.sin(this.fAngleYZ),this.fCameraDistance*Math.cos(this.fAngleYZ)*Math.sin(this.fAngleXZ)];this.arCameraEye[0]=this.arCameraLookAt[0]+g[0],this.arCameraEye[1]=this.arCameraLookAt[1]+g[1],this.arCameraEye[2]=this.arCameraLookAt[2]+g[2];var h=mat4.create(),i=mat4.create(),j=mat4.create();mat4.identity(h),mat4.scale(h,[c,c,c],h),mat4.translate(h,[a,b,0],h),mat4.lookAt(this.arCameraEye,this.arCameraLookAt,[0,1,0],i),1==this.bCameraPerspective?mat4.perspective(this.nFov,this.nWidth/this.nHeight,.1,1e3,j):0==this.bCameraPerspective&&mat4.ortho(-this.nWidth/2,this.nWidth/2,-this.nHeight/2,this.nHeight/2,.1,1e3,j),f.uniformMatrix4fv(this.gl_Uniform_WorldMatrix,!1,h),f.uniformMatrix4fv(this.gl_Uniform_ViewMatrix,!1,i),f.uniformMatrix4fv(this.gl_Uniform_ProjectionMatrix,!1,j),1==this.gl_Tex_Cube.bIsLoaded&&(f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,this.gl_Tex_Cube),f.uniform1i(this.gl_Uniform_Texture,0)),f.uniform4fv(this.gl_Uniform_ModulateCordinate,[.0625,1,.0625*d,0]),f.uniform4fv(this.gl_Uniform_Color,e),f.enable(f.DEPTH_TEST),f.depthFunc(f.LEQUAL),e[3]<1?(f.enable(f.BLEND),f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA),f.blendEquation(f.FUNC_ADD)):f.disable(f.BLEND),f.bindBuffer(f.ARRAY_BUFFER,this.gl_VB_Position_Cube),f.vertexAttribPointer(this.gl_Attribute_VertexPosition,this.gl_VB_Position_Cube.itemSize,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,this.gl_VB_Color_Cube),f.vertexAttribPointer(this.gl_Attribute_VertexColor,this.gl_VB_Color_Cube.itemSize,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,this.gl_VB_Cordinate_Cube),f.vertexAttribPointer(this.gl_Attribute_VertexCordinate,this.gl_VB_Cordinate_Cube.itemSize,f.FLOAT,!1,0,0),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,this.gl_IB_Cube),f.drawElements(f.TRIANGLES,this.gl_IB_Cube.numItems,f.UNSIGNED_SHORT,0),f.bindBuffer(f.ARRAY_BUFFER,null),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null),f.bindTexture(f.TEXTURE_2D,null),f.disableVertexAttribArray(this.gl_Attribute_VertexPosition),f.disableVertexAttribArray(this.gl_Attribute_VertexColor),f.disableVertexAttribArray(this.gl_Attribute_VertexCordinate),f.useProgram(null)},clear:function(){var a=this.ctx;a.clearColor(0,0,0,0),a.viewport(0,0,this.nWidth,this.nHeight),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)}}),app.tetris.Rules.filterRules=function(a,b){var c=[{nLv:9,nScore:1e4,nLogicSpeed:100},{nLv:8,nScore:6e3,nLogicSpeed:150},{nLv:7,nScore:4e3,nLogicSpeed:250},{nLv:6,nScore:2500,nLogicSpeed:350},{nLv:5,nScore:2e3,nLogicSpeed:450},{nLv:4,nScore:1500,nLogicSpeed:550},{nLv:3,nScore:1e3,nLogicSpeed:650},{nLv:2,nScore:500,nLogicSpeed:1e3},{nLv:1,nScore:0,nLogicSpeed:1500}],d=function(a){var b=_.filter(c,function(b){return b.nScore<=a});return b.length>0?b[0]:void 0};b(d(a))},app.tetris.Rules.BlockList={create:function(){var a=[];return a[0]=new app.tetris.Game.BlockModel({sColor:"yellow",sCode:"O",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]}),a[1]=new app.tetris.Game.BlockModel({sColor:"sky",sCode:"I",nAngle:0,aMatrix:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]]}),a[2]=new app.tetris.Game.BlockModel({sColor:"orange",sCode:"L",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,1],[0,1,0,0],[0,0,0,0]]}),a[3]=new app.tetris.Game.BlockModel({sColor:"blue",sCode:"J",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,1],[0,0,0,1],[0,0,0,0]]}),a[4]=new app.tetris.Game.BlockModel({sColor:"green",sCode:"S",nAngle:0,aMatrix:[[0,0,0,0],[0,0,1,1],[0,1,1,0],[0,0,0,0]]}),a[5]=new app.tetris.Game.BlockModel({sColor:"red",sCode:"Z",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,0],[0,0,1,1],[0,0,0,0]]}),a[6]=new app.tetris.Game.BlockModel({sColor:"purple",sCode:"T",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,1],[0,0,1,0],[0,0,0,0]]}),a}},function(){var a=Backbone.View.extend({el:"#_container #_menu_view",template:"menu",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.render(),app.tetris.Network.Model.on("change:nRegisterUser change:nConnectedUser",$.proxy(function(a){this.onChangeCount(a)},this))},onChangeCount:function(a){var b=this.$el.find("._conn_user_cnt");b.find("._con_user").html(a.get("nConnectedUser")),b.find("._reg_user").html(a.get("nRegisterUser")),b.removeClass("pulse").hide().addClass("pulse").show()},onClickMenu:function(a){var b=$(a.currentTarget).attr("data-navigate");return app.tetris.Router.navigate(b,{trigger:!0}),!1},show:function(){this.render(),this.$el.show(),this.$el.find("._welcome").addClass("animated").addClass("pulse"),this.$el.addClass("animated").removeClass("fadeOutUp").addClass("fadeInDown"),this.$el.find("._conn_user_cnt").removeClass("pulse").addClass("animated").addClass("pulse").show();var a=this;setTimeout(function(){a.myScroll&&a.myScroll.refresh()},200)},hide:function(){this.$el.addClass("animated").removeClass("fadeInDown").addClass("fadeOutUp")},render:function(){var a={sName:app.tetris.Account.Info.userId,nConnectedUser:app.tetris.Network.Model.get("nConnectedUser"),nRegisterUser:app.tetris.Network.Model.get("nRegisterUser")},b=app.tetris.TemplateManager.get(this.template,a);return this.$el.html(b),this}});app.tetris.Menu.View=new a}(),app.tetris.init=function(a){app.tetris.config.setEnv(a||"development"),app.tetris.Network.init(),app.tetris.Router=app.tetris.Router.getInstance(),app.tetris.Game.StageView=app.tetris.Game.StageView.getInstance(),app.tetris.Network.startSession(),app.tetris.ui.BackButton.setEvents(),Backbone.history.start();var b=Backbone.history.fragment?Backbone.history.fragment:!1;app.tetris.Router.navigate(b,{trigger:!0}),$(function(){FastClick.attach(document.body)})},function(){var a=app.tetris,b=Backbone.Router.extend({routes:{login:"moveToStart",menu:"moveToMenu",single:"moveToSingleGame",multi:"moveToMultiGame",board:"moveToGameBoard",credit:"moveToCredit",logout:"moveToLogout",quick:"moveToQuickJoin","":"moveToStart"},execute:function(a,b){app.tetris.Account.Info.load();var c=Backbone.history.fragment;return app.tetris.Account.Info.isAuthenticated()||"login"===c?void(a&&a.apply(this,b)):(this.navigate("login",{trigger:!0}),void app.tetris.Account.Network.io.emit("reqLogin",app.tetris.Account.Info.getAccount()))},initialize:function(){this._welContainer=$("#_container"),this._hideAllScreens()},_hideAllScreens:function(){this._welContainer.find("#_dimmed_section").hide(),this._welContainer.find("._screen").hide(),this._welContainer.removeClass("animated").removeClass("fadeInDown"),a.ui.Header.View.hide(),a.ui.Footer.View.hide(),a.ui.BackButton.hide()},moveToStart:function(){this._hideAllScreens(),a.Account.View.show()},moveToLogout:function(){app.tetris.Account.Info.clear(),this.navigate("login",{trigger:!0})},moveToQuickJoin:function(){this._hideAllScreens(),a.ui.BackButton.show(),a.Game.StageView.setType("multi"),a.Game.StageView.show(),a.Game.StageView.openMultiQuickJoin()},moveToSingleGame:function(){this._hideAllScreens(),a.ui.BackButton.show(),a.Game.StageView.setType("single"),a.Game.StageView.show()},moveToMultiGame:function(){this._hideAllScreens(),a.ui.BackButton.show(),a.Game.StageView.setType("multi"),a.Game.StageView.show()},moveToGameBoard:function(){this._hideAllScreens(),a.Board.init(),a.Board.View.show(),a.ui.Header.View.changeTitle("ScoreBoard").show(),a.ui.Footer.View.show(),a.ui.BackButton.show()},moveToCredit:function(){this._hideAllScreens(),a.Credit.View.show(),a.ui.Header.View.changeTitle("Credit").show(),a.ui.BackButton.show()},moveBack:function(){window.history.back()},moveToMenu:function(){this._hideAllScreens(),a.Menu.View.show()}});app.tetris.Router={_oInstance:null,getInstance:function(){return null===this._oInstance&&(this._oInstance=new b),this._oInstance}}}();