/*! Tetris - v0.1.0 - 2014-05-20
* https://github.com/Jinkwon/tetris.js
* Copyright (c) 2014 LeeJinKwon; Licensed MIT */
function meta(t,e){document.write('<meta name="'+t+'" content="'+e+'">')}var app=app?app:{};app.tetris=app.tetris?app.tetris:{},app.tetris.Game={},app.tetris.Board={},app.tetris.Menu={},app.tetris.Rules={},app.tetris.Util={},app.tetris.Account={},app.tetris.ui={},app.tetris.ui.Footer={},app.tetris.ui.Header={},app.tetris.ui.Option={},app.tetris.Network={},app.tetris.Credit={},app.tetris.Webgl={},app.tetris.config={sMode:"development",sHost:""},app.tetris.config.setEnv=function(t){app.tetris.config.sMode=t,app.tetris.config._refresh()},app.tetris.config._refresh=function(){var t="";switch(app.tetris.config.sMode){case"production":t="http://serverurl";break;case"staging":t="http://localhost:8080";break;default:t="http://"+document.location.hostname+":8888"}app.tetris.config.sHost=t,app.tetris.config.sAccountUrl=t+"/account",app.tetris.config.sSessionUrl=t+"/session",app.tetris.config.sMonitorUrl=t+"/monitor",app.tetris.config.sGameUrl=t+"/game",app.tetris.config.sChatUrl=t+"/chat"},app.tetris.TemplateManager={templates:{},get:function(t,e){var i=this.templates[t];if(i){var n=_.template(i,e);return n}i=$.ajax({url:"./views/"+t+".html",async:!1}).responseText,this.templates[t]=i;var n=_.template(i,e);return n}},app.mobile={},app.mobile.metaInit=function(){meta("expires","-1"),meta("Cache-Control","No-Cache"),meta("Pragma","No-Cache"),meta("viewport","initial-scale=1.0, width=device-width, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"),meta("format-detection","address=no,telephone=no"),meta("apple-mobile-web-app-capable","yes"),meta("apple-mobile-web-app-status-bar-style","white"),meta("apple-touch-fullscreen","yes")},app.tetris.Network.init=function(t){var e,i,n,t=t?t:{},o="",s="",a="";iOS=!1;var r=function(){iOS?t.fRunLogin&&t.fRunLogin():window.location.href="login.html"},l=function(){c(),h()},c=function(){i=io.connect(app.tetris.config.sGameUrl),i.on("connect",function(){var t={sEmpNo:o,sEmpNm:s,sDeptNm:a};i.emit("reqJoin",t)}).on("disconnect",function(){i=io.connect(app.tetris.config.sGameUrl)}).on("resJoin",function(t){"ok"===t.sStatus?$("#ready_btn").show():"exist"===t.sStatus?(o=$.cookie("sEmpNo"),s=$.cookie("sEmpNm"),a=$.cookie("sDeptNm"),i.emit("reqReJoin",htReq)):"game"===t.sStatus?alert("이미 게임이 시작하였습니다."):(alert("서버와 접속이 원활하지 않습니다."),r())}).on("pushGameDone",function(){$("#ready_btn").show()}).on("resReady",function(t){e.resReady(t)}).on("resCancel",function(t){e.resCancel(t)}).on("pushStart",function(){e.start(!0)}).on("pushStop",function(){e.stop(!0)})},h=function(){n=io.connect(app.tetris.sChatUrl),n.on("connect",function(){n.emit("sendJoin",{sEmpNo:o,sEmpNm:s,sDeptNm:a})})},d=function(t){e=t};return l(),{oGameIo:i,oChatIo:n,bindViewer:d}},app.tetris.Network.startSession=function(){app.tetris.Network.oSessionIo=io.connect(app.tetris.config.sSessionUrl);var t=app.tetris.Network.oSessionIo;t.on("resConnectionCount",function(t){app.tetris.Network.Model.set({nConnectedUser:t.nConnectedUser,nRegisterUser:t.nRegisterUser})}),t.on("connect",function(){$("#selectable").empty(),t.emit("reqConnectionCount")})},function(){var t=Backbone.Model.extend({defaults:{nConnectedUser:0,nRegisterUser:0},initialize:function(){}});app.tetris.Network.Model=new t}(),app.tetris.Util.leadingSpaces=function(t,e){var i="";if(t=""+t,e>t.length)for(var n=0;e-t.length>n;n++)i+="0";return i+t},app.tetris.Util.makeGuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=0|16*Math.random(),i="x"==t?e:8|3&e;return i.toString(16)})},app.tetris.Util.isMobile=function(){var t=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t},function(){for(var t=0,e=["webkit","moz"],i=0;e.length>i&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var i=(new Date).getTime(),n=Math.max(0,16-(i-t)),o=window.setTimeout(function(){e(i+n)},n);return t=i+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}();var WebGLUtil={};WebGLUtil.createShader=function(t,e,i){var n=t.createShader(i);if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){for(var o=t.getShaderInfoLog(n);o.length>1&&32>o.charCodeAt(o.length-1);)o=o.substring(0,o.length-1);return alert(o),null}return n},WebGLUtil.loadImage=function(t,e,i){var n={};e.bIsLoaded=!1,n.img=new Image,n.img.src=i,n.img.onload=function(){t.bindTexture(t.TEXTURE_2D,e),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n.img),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null),e.bIsLoaded=!0},n.img.onerror=function(){alert("error load texture")}},WebGLUtil.loadShader=function(t){var e=null;return $.ajax({async:!1,url:t,success:function(t){e=t},dataType:"text"}),e},app.tetris.ui.BackButton={setEvents:function(){$(document).on("click","._close",$.proxy(function(t){this._clearAnimationClass($(t.currentTarget)),$(t.currentTarget).addClass("bounceIn").show(),app.tetris.Router.moveBack()},this))},show:function(){var t=$("#_container").find("._close");this._clearAnimationClass(t),t.show().addClass("rotateIn")},hide:function(){var t=$("#_container").find("._close");"none"!==t.css("display")?(this._clearAnimationClass(t),t.show().addClass("bounceOut").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){t.hide()})):(this._clearAnimationClass(t),t.hide())},_clearAnimationClass:function(t){t.removeClass("bounceIn").removeClass("rotateIn")}},function(){var t=Backbone.View.extend({el:"#_container #_footer",template:"ui/footer",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.render()},onClickMenu:function(){return!1},show:function(){return this.render(),this.$el.addClass("animated").addClass("fadeInDown").show(),this},hide:function(){this.$el.hide()},render:function(){var t=app.tetris.TemplateManager.get(this.template,{});return this.$el.html(t),this}});app.tetris.ui.Footer.View=new t}(),function(){var t="HEADER",e=Backbone.View.extend({el:"#_container #_header",template:"ui/header",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.sTitle=t,this.setEvents(),this.render()},setEvents:function(){this.model.bind("change",$.proxy(this.render,this))},onClickMenu:function(){return!1},show:function(){return this.render(),this.$el.addClass("animated").addClass("fadeInUp").show(),this},hide:function(){this.$el.hide(),this.sTitle=t},changeTitle:function(t){return this.sTitle=t,this},render:function(){var t={sTitle:this.sTitle,nConnectedUser:this.model.get("nConnectedUser")},e=app.tetris.TemplateManager.get(this.template,t);return this.$el.html(e),this}});app.tetris.ui.Header.View=new e({model:app.tetris.Network.Model})}(),app.tetris.ui.Option.View=Backbone.View.extend({el:"#_container #_option",template:"ui/option",events:{"click ._menu_item":"onClickMenu"},initialize:function(){},_setOptionListIdx:function(t){for(var e=0;t.length>e;e++)t[e].id=e;this.aOptionList=t},onClickMenu:function(t){this.unbind();var e,i=$(t.currentTarget).attr("data-idx");return this.aOptionList[i].fn&&(e=this.aOptionList[i].fn()),e!==!1&&this.hide(),!1},show:function(t){this._setOptionListIdx(t.aList||[]),this.sTitle=t.sTitle||"Options",this.showDimmedLayer(),$("#_dimmed_section").show(),this.render(),this.$el.show(),this.$el.find(".option_container").removeClass("animated flipInY").addClass("animated flipInY").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass("animated flipInY")})},hide:function(){var t=this;this.$el.find(".option_container").removeClass("animated05 fadeOutDown").addClass("animated05 fadeOutDown").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass("animated05 fadeOutDown"),t.$el.hide()}),this.hideDimmed()},hideDimmed:function(){$("#_dimmed_section").hide()},showDimmedLayer:function(t){return $("#_dimmed_section .pause").length>0?($("#_dimmed_section").show(),void 0):(t=t||"",$(".field .pause").remove(),$("#_dimmed_section").html('<div class="pause" style="z-index:50;width:100%;height:100%;background-color:rgba(0,0,0,.7);position:absolute;color:#FFF;font-size:27px;font-family:Tahoma;"><div style="margin:auto;width:100%;height:25px;text-align:center;margin-top:200px;">'+t+"</div></div>").show(),void 0)},render:function(){var t=app.tetris.TemplateManager.get(this.template,{aList:this.aOptionList,sTitle:this.sTitle});return this.$el.html(t),this}}),app.tetris.ui.Option.View=new app.tetris.ui.Option.View,function(){var t=function(){this.userId="",this.passwd="",this.bAvail=!1};t.prototype={_listeners:[],setAccount:function(t,e){this.userId=t,this.passwd=e},getAccount:function(){return{userId:this.userId,passwd:this.passwd}},on:function(t,e){return this.listeners=_.filter(this.listeners,function(e){return e.sEvent!==t}),this.listeners.push({fn:e,sEvent:t}),this},save:function(){""!==this.userId&&""!==this.passwd&&window.localStorage.setItem("account",JSON.stringify({userId:this.userId,passwd:this.passwd}))},load:function(){var t=window.localStorage.getItem("account"),e=JSON.parse(t)||{userId:"",passwd:""};this.userId=e.userId,this.passwd=e.passwd},clear:function(){window.localStorage.removeItem("account"),this.userId="",this.passwd="",this.bAvail=!1},broadcast:function(t){return _.each(this.listeners,function(e){e.sEvent===t&&e.fn()}),this},isAuthenticated:function(){return this.bAvail}},app.tetris.Account.Info=new t}(),app.tetris.Account.Network={},app.tetris.Account.Network.connect=function(t){app.tetris.Account.Network.io||(app.tetris.Account.Network.io=io.connect(app.tetris.config.sAccountUrl,{timeout:5e3}),app.tetris.Account.Network.io.on("connection",function(){t&&t(),app.tetris.Account.Network.io.emit("reqLogin",app.tetris.Account.Info.getAccount())}).on("reconnect",function(){app.tetris.Account.Network.io.emit("reqLogin",app.tetris.Account.Info.getAccount())}).on("disconnect",function(){alert("disconnected")}).on("error",function(){alert("Cannot connect to Server"),app.tetris.Account.Network.io=null}).on("reconnect_failed",function(){console.log("reconnect_failed")}).on("connect_failed",function(t){console.log(t),alert("Connect failed")}).on("resLogin",function(t){console.log(t.bAvail),app.tetris.Account.Info.bAvail=t.bAvail,app.tetris.Account.Info.bAvail?app.tetris.Account.Info.broadcast("onSuccessLogin"):app.tetris.Account.Info.broadcast("onFailLogin")}).on("resJoin",function(t){return t.bAvail===!1?(alert(t.sMessage),void 0):(app.tetris.Account.Info.on("onSuccessLogin",function(){app.tetris.Account.Info.save(),app.tetris.Menu.View.render(),app.tetris.Router.navigate("menu",{trigger:!0})}),app.tetris.Account.Network.io.emit("reqLogin",app.tetris.Account.Info.getAccount()),void 0)})),app.tetris.Account.Network.io.socket.connected===!1&&app.tetris.Account.Network.io.socket.connecting===!1?app.tetris.Account.Network.io.socket.connect():t&&t()},function(){var t=Backbone.View.extend({el:"#_container #_start_view",template:"start",events:{"click ._splash_section":"_onClickSplash","click ._join_btn":"_onClickJoin","click ._login_btn":"_onClickLogin"},initialize:function(){this.render()},assignElements:function(){this.welPw=this.$el.find("._pw"),this.welPwRe=this.$el.find("._pw_re"),this.welId=this.$el.find("._id")},_checkLoginValidation:function(){return""===this.welId.val().trim()?(alert("Please insert Id"),this.welId.focus(),!1):""===this.welPw.val().trim()?(alert("Please insert Password"),this.welPw.focus(),!1):!0},_checkJoinValidation:function(){return this._checkLoginValidation()?this.welPw.val()!==this.welPwRe.val()?(alert("Not same password"),!1):!0:!1},_onClickLogin:function(){this._checkLoginValidation()&&app.tetris.Account.Network.connect($.proxy(function(){this._updateAccount(),this._setAccountEvents(),app.tetris.Account.Network.io.emit("reqLogin",app.tetris.Account.Info.getAccount())},this))},_onClickJoin:function(){return"none"===this.welPwRe.css("display")?(this.welPwRe.show().css("height",0).animate({height:this.welPw.outerHeight()+"px"},250,"easeOutBounce"),void 0):(this._checkJoinValidation()&&app.tetris.Account.Network.connect($.proxy(function(){this._updateAccount(),this._setAccountEvents(),app.tetris.Account.Network.io.emit("reqJoin",app.tetris.Account.Info.getAccount())},this)),void 0)},_updateAccount:function(){var t=this.$el.find("._id").val(),e=this.$el.find("._pw").val();app.tetris.Account.Info.setAccount(t,e)},_setAccountEvents:function(){app.tetris.Account.Info.on("onFailLogin",function(){alert("Invalid Id or Password")}),app.tetris.Account.Info.on("onSuccessLogin",function(){app.tetris.Account.Info.save(),app.tetris.Router.navigate("menu",{trigger:!0})})},_onClickSplash:function(){return"none"!==this.$el.find("#_login_form").css("display")?(this._resetDisplay(),void 0):(this.$el.find("._start_btn").removeClass("flipInY").addClass("fadeOutUp"),app.tetris.Account.Info.isAuthenticated()?app.tetris.Router.navigate("menu",{trigger:!0}):(this.hide(),this.$el.find("#_login_form").addClass("flipInX").show()),!1)},hide:function(){this.$el.find("._title").addClass("fadeOutUp").show()},_updateInputs:function(){var t=app.tetris.Account.Info.getAccount();this.$el.find("._id").val(t.userId),this.$el.find("._pw").val(t.passwd),this.$el.find("._pw_re").val(t.passwd),this.welPwRe.hide()},_playShowAnimation:function(){this.$el.find("._start_btn").removeClass("flipOutX").removeClass("flipOutY").addClass("flipInY"),this.$el.find("._title").removeClass("fadeOutUp").addClass("flipInX")},_hideLoginForm:function(){this.$el.find("#_login_form").hide()},_resetDisplay:function(){this._updateInputs(),this._hideLoginForm(),this._playShowAnimation()},show:function(){this._resetDisplay(),this.$el.show()},render:function(){var t=app.tetris.TemplateManager.get(this.template,{});return this.$el.html(t),this.assignElements(),this}});app.tetris.Account.View=new t}(),app.tetris.Board.init=function(t){if(!app.tetris.Board.bInitialized){var e=io.connect(app.tetris.config.sMonitorUrl),i=0,n=[];navigator.userAgent.match(/(iPad|iPhone|iPod)/i)?!0:!1;var o=function(){n=[],$("#_watch").empty(),$("#_gamePeople .ui-selected").each(function(){var t=$(this).attr("id").replace("_gp_",""),e=$(this).text();n.push(t);var i=[];i.push('<li class="other_user">'),i.push('<canvas id="_watch_'+t+'" width="100" height="210" class="other_user_canvas"></canvas>'),i.push('<div id="_info_'+t+'" class="info">'+e+"</div>"),i.push("</li>"),$("#_watch").append(i.join(""))}),e.emit("sendSelectedGamePeople",n)},s=function(){e.on("resAdmin",function(t){"ok"===t?$("#_start").show():"game"===t&&$("#_stop").show()}),e.on("pushPeopleInfo",function(t){var e=t.aConnectedPeople||[],n=t.aGamePeople||[],s=e.length||0;i=n.length||0,this.bRealGame=t.bRealGame,$("#_currentConnectedPeople").text(s),$("#_currentGamePeople").text(i);for(var a=[],r=0;s>r;r++)a.push('<li id="_cp_'+e[r].sEmpNo+'">'+e[r].sEmpNm+"</li>");$("#_connectedPeople").html(a.join(""));for(var a=[],r=0;i>r;r++)this.bRealGame?(nScore=void 0===n[r].nScore?0:n[r].nScore,a.push('<li id="_gp_'+n[r].sEmpNo+'">'+n[r].sEmpNm+" - "+nScore+"점</li>")):a.push('<li id="_gp_'+n[r].sEmpNo+'">'+n[r].sEmpNm+"</li>");$("#_gamePeople").html(a.join("")).selectable({selected:function(){o()},stop:function(){o()}})}),e.on("pushGameInfo",function(t){$("#_info_"+t.sEmpNo).text(t.sEmpNm+" - "+t.nScore+"점")})},a=function(){$("#selectable").selectable(),s(),$("#_join").show(),$("#_start").on("click",function(){return 0===i?(alert("There is no ready people for gaming.\nTell people to be ready."),void 0):(confirm("Do you really want to start the game?")&&($(this).hide(),$("#_stop").show(),e.emit("sendStart"),this.bRealGame=!0),void 0)}),$("#_stop").on("click",function(){$(this).hide(),$("#_start").show(),e.emit("sendStop")}),app.tetris.Board.bInitialized=!0};a()}},function(){var t=Backbone.View.extend({el:"#_container #_gameboard_view",template:"board",defaults:{oWebGLView:{},_bWebGLOn:!1},events:{"click._move_to_menu":"moveToMenu"},initialize:function(){this.render()},show:function(){this.$el.hide().stop().fadeIn(300)},hide:function(){this.$el.hide()},moveToMenu:function(){app.tetris.Router.navigate("menu",{trigger:!0})},render:function(){return app.tetris.TemplateManager.get(this.template,{},$.proxy(function(t){this.$el.html(t)},this)),this}});app.tetris.Board.View=new t}(),function(){var t=Backbone.View.extend({el:"#_container #_credit_view",template:"credit",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.setEvents(),this.render()},setEvents:function(){},onClickMenu:function(){return!1},show:function(){this.$el.show(),this.$el.addClass("animated").removeClass("fadeInUp").addClass("fadeInDown")},hide:function(){this.$el.addClass("animated").removeClass("fadeInDown").addClass("fadeInUp")},render:function(){var t={},e=app.tetris.TemplateManager.get(this.template,t);return this.$el.html(e),this}});app.tetris.Credit.View=new t}(),app.tetris.Game.BlockModel=Backbone.Model.extend({defaults:function(){return{sColor:"",sCode:"",nAngle:0,aMatrix:[]}}}),app.tetris.Game.init=function(t){return t=t?t:{},void 0},app.tetris.Game.Model=Backbone.Model.extend({defaults:function(){return{nScore:0,sGameStatus:"stop",nBlockPixel:null,aBlocks:null,nNumber:2,nCols:0,nRows:0,sGuid:"",aMatrix:[],nGameStartTime:0,oBlockCollection:{},htBlockPos:{nX:0,nY:0}}},initialize:function(){this.set({nScore:0,htBlockPos:{nX:5,nY:0},nCols:10,nRows:20,nBlockPixel:22}),this.set("sGuid",app.tetris.Util.makeGuid());var t=Backbone.Collection.extend({model:app.tetris.Game.BlockModel}),e=new t;e.add(app.tetris.Rules.BlockList.create()),this.set("oBlockCollection",e),this.initMatrix()},plusScore:function(t){var e=this.get("nScore");this.set("nScore",e+t)},clearFullLine:function(){for(var t,e,i,n=this.get("aMatrix"),o=this.get("nCols"),s=this.get("nRows"),a=0,r=0;s+2>r;r++){e=0;for(var l=1;o+1>l;l++)1==n[r][l].nFlag&&e++;if(e==o&&s+1>r){n.splice(r,1),i=[];for(var c=0;o+1>=c;c++)t=0===c||c===o+1?1:0,i.push({nFlag:t});n.unshift(i),a++}}return this.setMatrix(n),a},setBlockToMatrix:function(t,e){for(var i,n,o=t.get("aMatrix"),s=t.get("sColor"),a=this.getMatrix(),r=0;o.length>r;r++)for(var l=0;o[r].length>l;l++)i=l+e.nX,n=r+e.nY,void 0!==a[n]&&void 0!==a[n][i]&&1!==a[n][i].nFlag&&(a[n][i].nFlag=o[r][l],a[n][i].sColor=s);this.setMatrix(a)},setBlockPosXY:function(t,e){this.set("htBlockPos",{nX:t,nY:e})},getRandomRange:function(){var t=0,e=this.get("oBlockCollection").length-1;return Math.floor(Math.random()*(e-t+1)+t)},initMatrix:function(){for(var t=[],e=this.get("nCols"),i=this.get("nRows"),n=0;i+2>n;n++){t[n]=[];for(var o=0;e+2>o;o++)t[n][o]=0==o||o==e+1||n>i?{nFlag:1}:{nFlag:0}}this.setMatrix(t)},setMatrix:function(t){this.set("aMatrix",t)},getMatrix:function(){return this.get("aMatrix")}}),app.tetris.Game.Network={},app.tetris.Game.Network.init=function(){var t=io.connect(app.tetris.config.sSessionUrl),e=io.connect(app.tetris.config.sGameUrl);t.on("connect",function(){console.log(arguments)}),e.on("connect",function(){console.log(arguments),e.emit("reqJoinLeague",{})}).on("brLeagueClosed",function(){console.log(arguments)})},function(){var t=Backbone.View.extend({el:"#_container #_single_view",template:"stage/stage.mobile",initialize:function(){this._setViewProperties(),this._initTimer(),this.setUIEvents(),this.setLogicEvents(),this.render()},setType:function(t){this._sType=t},_setViewProperties:function(){this.arColorPos={red:1,orange:2,yellow:3,green:4,sky:5,blue:6,purple:7,sand:8,leaf:9,brown:10,leaf2:11,sky2:12,sand2:13,stone:14},this._onTouchKeyPadWithContext=$.proxy(this._onTouchKeyPad,this),this._isDrawNextGroupBlock=!1},_onTouchKeyPad:function(t){if(t.stopPropagation(),t.preventDefault(),this.model.get("sGameStatus"),"play"!==this.model.get("sGameStatus"))return!1;if(t.handled!==!0){var e=$(t.currentTarget).attr("id");"down"===e?this.oGameView.moveDown(!0):"right"===e?this.oGameView.moveBlock("right"):"left"===e?this.oGameView.moveBlock("left"):"up"===e?this.oGameView.rotateBlock("right"):"harddown"===e&&this.oGameView.moveHardDown(),t.handled=!0}return!1},setLogicEvents:function(){app.tetris.Router.on("route",$.proxy(function(){this.oGameView&&this.oGameView.unbind()},this))},_renderScore:function(){var t=this.model.get("nScore"),e=this.$el.find(".score");e.empty().html(t),this.playUIAnimation(e.parent(),"pulse")},playUIAnimation:function(t,e,i){var n=".5"===i?"animated05":"animated",o="webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",s=function(){$(this).removeClass(n+" "+e)};t.removeClass(n+" "+e).addClass(n+" "+e).one(o,s)},onBlockChange:function(){this.drawNextBlock()},drawNextBlock:function(){var t=this.model.get("oBlockCollection"),e=this.model.get("nextBlock")[0];if(t.at(e)){var i=this.getBlockString(t.at(e).get("aMatrix"),t.at(e).get("sColor"),16,"next");if($(".next_block_container").empty().append(i),this._isDrawNextGroupBlock){$(".next_group_block_container").empty();for(var n=0;3>n;n++)e=this.model.get("nextBlock")[n+1],i=this.getBlockString(t.at(e).get("aMatrix"),t.at(e).get("sColor"),12,"next_"+n),$(".next_group_block_container").append(i+'<div style="clear:both;height:43px;"></div>')}this.playUIAnimation($("._next_block"),"fadeInDown")}},getPosPixelByColor:function(t,e){return this.arColorPos[t]*e},getBlockString:function(t,e,i,n){for(var o,s=['<div class="single_block" style="clear:both;" id="'+n+'">'],a=0;t.length>a;a++){for(var r=0;t[a].length>r;r++)1==t[a][r]?(o=this.getPosPixelByColor(e,i),s.push('<div class="fill_block_'+i+'" style="width:'+i+"px;height:"+i+"px;background-position:-"+o+'px 0;"></div>')):s.push('<div class="empty_block" style="width:'+i+"px;height:"+i+'px;"></div>');s.push('<div class="clear"></div>')}return s.push("</div><br>"),s.join("")},render:function(){var t=app.tetris.TemplateManager.get(this.template,{});return this.$el.html(t),app.tetris.Util.isMobile()?$("._mobile").show():$("._mobile").hide(),this},clearOldViewObject:function(){this.oGameView&&this.oGameView.unbind(),this.oGameView2&&this.oGameView2.unbind(),this.oGameView3&&this.oGameView3.unbind()},show:function(){this.$el.show(),this.clearOldViewObject(),this.initGame(),this._renderScore()},setGameEvents:function(){this.$el.off("touchstart mousedown",".jpad",this._onTouchKeyPadWithContext).on("touchstart mousedown",".jpad",this._onTouchKeyPadWithContext)},bindModelEvents:function(){this.model.bind("change:sGameStatus",this.watchGameStatus,this),this.model.bind("change:htBlockPos",this.onBlockChange,this),this.model.bind("change:nScore",this._renderScore,this),this.model.bind("change:nScore change:htBlockPos",function(){console.log("sendData")})},initGame:function(){this.model=new app.tetris.Game.Model,this.bindModelEvents(),this.oGameView=new app.tetris.Game.View({el:"#single_game_area",model:this.model,bEventBind:!0,bUseWebGL:!1,bUseSound:!0}),this.startTimer(),this.oGameView.start(),this.setGameEvents(),this.oGameView2=new app.tetris.Game.View({el:"#other_1_game_area",model:new app.tetris.Game.Model,bUseWebGL:!1,bUseSound:!1}),this.oGameView3=new app.tetris.Game.View({el:"#other_2_game_area",model:new app.tetris.Game.Model,bUseWebGL:!1});var t=$(this.$el);this._setGameEvents(t)},excuteTick:function(){var t=this.nGameStartTime;t+=1e3;var e=new Date(t),i=app.tetris.Util.leadingSpaces(e.getMinutes(),2),n=app.tetris.Util.leadingSpaces(e.getSeconds(),2);this.drawTime(i,n),this.nGameStartTime=t,this.model.set("nGameStartTime",t)},drawTime:function(t,e){var i=this.$el.find("._play_time");i.html(t+":"+e),this.playUIAnimation(i,"rubberBand",".5")},_initTimer:function(){this.drawTime("00","00"),this.stopTimer()},startTimer:function(){var t=this;this.nGameStartTime=this.model.get("nGameStartTime"),this.stopTimer(),this.excuteTick(),this.timer=setInterval(function(){t.excuteTick()},1e3)},stopTimer:function(){clearTimeout(this.timer)},watchGameStatus:function(){var t=this.model.get("sGameStatus");"start"===t||("play"===t?($(".field .pause").remove(),this.startTimer()):"pause"===t?(this.stopTimer(),this.openDimmedLayer("Pause")):"stop"===t?(this._initTimer(),this.openDimmedLayer("Hello TETRIS")):"ready"===t?this.openDimmedLayer("Ready"):"game"===t?this.openDimmedLayer("Already Started"):"end"===t?(this.stopTimer(),this.openDimmedLayer(),this.openGameMenu("Game Over")):this.stopTimer())},logChat:function(t){var e=$(".chat_area").html();$(".chat_area").html(e+t+"<br>"),$(".chat_area").scrollTop($(".chat_area")[0].scrollHeight)},_setGameEvents:function(t){t.find("#start_btn").bind("click",$.proxy(this.oGameView.start,this.oGameView)),t.find("#stop_btn").bind("click",$.proxy(this.oGameView.stop,this.oGameView)),t.find("#ready_btn").bind("click",$.proxy(this.oGameView.reqReady,this.oGameView)),t.find("#cancel_btn").bind("click",$.proxy(this.oGameView.reqCancel,this.oGameView)),t.find("#start_touch").bind("click",$.proxy(this.oGameView.start,this.oGameView)),t.find("#debug_btn").bind("click",$.proxy(this.oGameView.debugStart,this.oGameView))},setUIEvents:function(){var t=this.$el;t.find("#ssamdi").on("click",$.proxy(function(){this._bWebGLOn=this._bWebGLOn===!0?!1:!0},this.oGameView)),t.find("#fullscreen_btn").bind("click",function(){var t=document.documentElement,e=t.requestFullScreen||t.webkitRequestFullScreen||t.mozRequestFullScreen;e.call(t)}),t.find("#fullscreen_btn").bind("click",$.proxy(this._onClickFullScreen,this)),this.$el.on("click","._option",$.proxy(function(){this.openOptionMenu()},this))},openOptionMenu:function(){var t=function(){return app.tetris.ui.Option.View.show({aList:[{sLabel:"test"},{sLabel:"test2"},{sLabel:"Back",fn:$.proxy(this.openOptionMenu,this)}]}),!1},e=function(){app.tetris.Router.navigate("menu",{trigger:!0})},i=function(){this.oGameView.pause()};return app.tetris.ui.Option.View.show({aList:[{sLabel:"Continue"},{sLabel:"Pause",fn:$.proxy(i,this)},{sLabel:"Setting",fn:$.proxy(t,this)},{sLabel:"Menu",fn:$.proxy(e,this)}]}),!1},openGameMenu:function(t){var e=function(){this.oGameView.start()},i=function(){},n=function(){app.tetris.Router.navigate("menu",{trigger:!0})};app.tetris.ui.Option.View.show({sTitle:t||"",aList:[{sLabel:"Replay Game",fn:$.proxy(e,this)},{sLabel:"Join Multi Game",fn:$.proxy(i,this)},{sLabel:"Go to Menu",fn:$.proxy(n,this)}]})},_onClickFullScreen:function(){if(1==that.bFullScreen)that.bFullScreen=!1;else{var t=document.documentElement,e=t.requestFullScreen||t.webkitRequestFullScreen||t.mozRequestFullScreen;e.call(t),that.bFullScreen=!0}},openDimmedLayer:function(t){t=t||"",$(".field .pause").remove(),$("#_dimmed_section").html('<div class="pause" style="z-index:50;width:100%;height:100%;background-color:rgba(0,0,0,.7);position:absolute;color:#FFF;font-size:27px;font-family:Tahoma;"><div style="margin:auto;width:100%;height:25px;text-align:center;margin-top:200px;">'+t+"</div></div>").show()}});app.tetris.Game.StageView={_oInstance:null,getInstance:function(){return null===this._oInstance&&(this._oInstance=new t),this._oInstance}}}(),app.tetris.Game.Util={checkCollision:function(t,e,i,n){for(var o,s,a=!1,r=e.get("aMatrix"),l=0;r.length>l;l++)for(var c=0;r[l].length>c;c++)if(o=c+t.nX,s=l+t.nY,"bottom"===i?s+=1:("left"===i||"right"===i)&&(o="left"===i?o-1:o+1),void 0!==n[s]&&void 0!==n[s][o]&&1===n[s][o].nFlag&&1===r[l][c]){a=!0;break}return a},rotateBlockArray:function(t,e,i,n){var o,s=e.get("aMatrix"),a=e.get("sCode"),r=e.get("nAngle"),l=[],c=!1;if("O"!==a&&(c=!0),("S"===a||"I"===a||"Z"===a)&&r>0&&(t="left"),c===!0)if("right"===t){r=(r+90)%360;for(var h=s[0].length-1;h>=0;h--){o=[],o.push(s[3][h]);for(var d=0;s.length-1>d;d++)o.push(s[d][h]);l.push(o)}}else{r=(r-90)%360;for(var h=1;s.length>h;h++){o=[];for(var d=s[0].length-1;d>=0;d--)o.push(s[d][h]);l.push(o)}o=[];for(var d=s[0].length-1;d>=0;d--)o.push(s[d][0]);l.push(o)}return this.checkCollision(i,e,l,t,n)||(s=l),e.set({aMatrix:s,nAngle:r}),e}},app.tetris.Game.View=Backbone.View.extend({defaults:{oWebGLView:{},_bWebGLOn:!0},initialize:function(t){this.Util=app.tetris.Game.Util,this.render(),this.oUIView=t.oUIView,this.oGameIo=t.oGameIo||{},this.bEventBind=t.bEventBind||!1,this._bUseSound=t.bUseSound||!1,this._bWebGLOn=t.bUseWebGL?t.bUseWebGL:!1,this._bWebGLOn&&(this.oWebGLView=new app.tetris.Game.WebGLView({el:this.$el.find("._tetris_webgl_canvas")})),this._fnKeyEvent=$.proxy(this._onKeyAction,this),this.initResources(),this.resetData(),this.initCanvas(),this.bEventBind&&this.bindEvents(),this.drawMyStage(),this.nMargin=t.nMargin||0,this.bFullScreen=!1},render:function(){this.$el.html('<canvas class="_tetris_webgl_canvas" style="width:100%;height:100%;position:absolute;z-index:10;left:0px;display:block;"></canvas><canvas class="_tetris_origin_canvas" style="width:100%;height:100%;"> </canvas>')},resetData:function(){this.nTickCnt=0,this.tickTime=35,this.nLogicTickCnt=0,this.nLogicSpeed=1500,this.nLongPressCnt=0,this.level=1,this.model.set("nGameStartTime",0),this.model.set("nScore",0),this.initMatrix()},initResources:function(){this.blockImg=[],this.blockImg[22]=new Image,this.blockImg[22].src="./res/img/mino_main.png",this.blockImg[10]=new Image,this.blockImg[10].src="./res/img/mino_sub.png",this.arColorPos={red:1,orange:2,yellow:3,green:4,sky:5,blue:6,purple:7,sand:8,leaf:9,brown:10,leaf2:11,sky2:12,sand2:13,stone:14},this.initAudio()},initAudio:function(){this.htSound={},this._bUseSound&&(this.htSound={harddrop:new Howl({urls:["../res/sound/TE_SE_harddrop.mp3"],volume:.3}),softdrop:new Howl({urls:["../res/sound/TE_SE_softdrop.mp3"],volume:.3}),lockdown:new Howl({urls:["../res/sound/TE_SE_lockdown.mp3"],volume:.3})})},initCanvas:function(){this.ctx={stage:this.getOriginCanvasObject()},this.nWidth=$(this.ctx.stage.elCanvas).width(),this.nHeight=$(this.ctx.stage.elCanvas).height(),this.ctx.stage.nWidth=this.nWidth,this.ctx.stage.nHeight=this.nHeight,$(this.ctx.stage.elCanvas).attr("width",this.nWidth+"px").attr("height",this.nHeight+"px"),this.ctx.stage.ctx.imageSmoothingEnabled=!1,this.ctx.stage.ctx.webkitImageSmoothingEnabled=!1,this.ctx.stage.ctx.mozImageSmoothingEnabled=!1,this._bWebGLOn&&this.oWebGLView.isAvailWebGL()&&this.oWebGLView.initCanvas()
},controlSound:function(t,e){return this.htSound[t]&&this._bUseSound?("play"===e?this.htSound[t].play():"stop"===e&&this.htSound[t].pause(),void 0):!1},bindEvents:function(){var t=this;$(window).on("resize",function(){t.initCanvas()})},drawGhostBlock:function(){for(var t=this.model.get("htBlockPos"),e=0,i=0;35>i;i++)if(e=t.nY+i,this.Util.checkCollision({nX:t.nX,nY:t.nY+i},this.model.get("currentBlock"),"bottom",this.model.get("aMatrix"))){this.drawMovingBlock(this.model.get("currentBlock"),{nX:t.nX,nY:e},!0);break}},drawMovingBlock:function(t,e,i){e=e||this.model.get("htBlockPos");var n,o,s,a=t?t.get("aMatrix"):this.model.get("currentBlock").get("aMatrix"),r=t?t.get("sColor"):this.model.get("currentBlock").get("sColor"),l=this.ctx.stage;if(void 0!==a)for(var c=0;a.length>c;c++)for(var h=0;a[c].length>h;h++)s=!1,1===a[c][h]&&(s=!0),this.debugMode&&s===!1&&(r="stone",s=!0),s&&(n=h+e.nX-1,o=c+e.nY,this.drawBlock(l.ctx,r,l.nBlockSize,n,o,i?.2:1))},drawMyStage:function(){this.drawStage(this.ctx.stage,this.getMatrix()),this.debugMode&&this.drawDebugStage()},drawStage:function(t,e,i){if(0!==e.length){var n=e.length,o=e[0].length,s=t.ctx,a=t.nBlockSize;this.clearScreen(t);for(var r=0;n>r;r++)for(var l=0;o>l;l++)if(1===e[r][l].nFlag){var c=e[r][l].sColor;this.drawBlock(s,c,a,l-1,r,1,i)}}},drawToWebGL:function(t,e,i,n,o){var s=this.getMatrix(),a=s.length,r=s[0].length,l=(r-1)*t/2-22,c=(a+1)/2*t+5,h=0;this.oWebGLView.bCameraPerspective=!0,this.oWebGLView.arCameraLookAt=[l,c,h],this.oWebGLView.drawBlock(e,a-i,t,this.arColorPos[n],[1,1,1,o])},drawToCanvas:function(t,e,i,n,o,s){var a=this.ctx.stage.ctx;void 0===s&&(s=this.ctx.stage.nHeight/20);var r=this.getPosPixelByColor(n,t);a.globalAlpha=o;var l=this.ctx.stage.nWidth/10,c=this.ctx.stage.nHeight/20;a.drawImage(this.blockImg[t],r,0,t,t,e*l,i*c-s,l,c),a.globalAlpha=1},drawBlock:function(t,e,i,n,o,s,a){if(void 0===e||void 0===t)return!1;var r=this._bWebGLOn;this.ctx&&t==this.ctx.stage.ctx&&void 0!==this.oWebGLView&&(r=this.oWebGLView.isAvailWebGL()&&this._bWebGLOn===!0?!0:!1),r?this.drawToWebGL(i,n,o,e,s):this.drawToCanvas(i,n,o,e,s,a)},clearScreen:function(t){return t.ctx.clearRect(0,0,t.nWidth,t.nHeight),void 0===this.ctx?null:(t.ctx==this.ctx.stage.ctx&&void 0!==this.oWebGLView&&this.oWebGLView.isAvailWebGL()&&this.oWebGLView.clear(),void 0)},getOriginCanvasObject:function(){return this.getCanvasObjectBy("canvas")},getCanvasObjectBy:function(t){var e=null;switch(t){case"canvas":e=this.$el.find("._tetris_origin_canvas")[0]}var i=$(e).hasClass("game_area")?this.model.get("nBlockPixel"):10;return null===e?!1:{elCanvas:e,ctx:e.getContext("2d"),nWidth:e.width,nHeight:e.height,nBlockSize:i}},setGameStatus:function(t){this.model.set("sGameStatus",t),"start"===t&&(this.debugMode=!1,$("#debug_area").empty().hide(),$(".pause").remove())},bindKeyEvents:function(){this.htKeyState={},$(document).off("keydown keyup",this._fnKeyEvent).on("keydown keyup",this._fnKeyEvent)},getGameStatus:function(){return this.model.get("sGameStatus")},checkLevelUp:function(){this.model.get("nScore")>=100&&2>this.level||this.model.get("nScore")>=1e3&&3>this.level||this.model.get("nScore")>=2e3&&4>this.level},renderCanvas:function(){this.drawMyStage(),this.drawMovingBlock(),this.drawGhostBlock()},tick:function(){this.renderCanvas(),this.nTickCnt+=this.tickTime,this.nLogicTickCnt+=this.tickTime,this.nLogicTickCnt>this.nLogicSpeed&&(this.setGameStatus("play"),this.moveDown(!0),this.nLogicTickCnt-=this.nLogicSpeed),1==this.keyPressFlag&&(this.htKeyState[37]?this.moveBlock("left"):this.htKeyState[39]&&this.moveBlock("right"))},start:function(t){if("start"!==this.getGameStatus()){var e=$(this.el);t?(e.find("#start_btn").hide(),e.find("#stop_btn").hide(),e.find("#cancel_btn").hide()):(e.find("#start_btn").hide(),e.find("#stop_btn").show()),this.resetData(),this.setGameStatus("start"),this.model.set("nextBlock",[]);for(var i=0;5>=i;i++){var n=this.model.get("nextBlock");n.push(this.model.getRandomRange()),this.model.set("nextBlock",n)}this.makeNewBlock(),this.stopAnimationLoop(),this.startAnimationLoop(),this.tick(),this.bEventBind&&this.bindKeyEvents()}},stopAnimationLoop:function(){cancelAnimationFrame(this.ticker)},startAnimationLoop:function(){this.ticker=requestAnimationFrame($.proxy(this.startAnimationLoop,this)),this.tick()},debugStart:function(){if("start"!==this.getGameStatus()){$(".pause").remove(),this.debugMode=!0,this.setGameStatus("debug"),this.resetData(),this.model.set("nextBlock",[]);for(var t=0;5>=t;t++){var e=this.model.get("nextBlock");e.push(this.model.getRandomRange()),this.model.set("nextBlock",e)}this.makeNewBlock(),this.bindKeyEvents(),this.drawMyStage()}},pause:function(){"pause"==this.model.get("sGameStatus")?(this.setGameStatus("play"),this.startAnimationLoop()):(this.stopAnimationLoop(),this.setGameStatus("pause"))},stop:function(){this.setGameStatus("stop"),$(".pause").remove(),cancelAnimationFrame(this.ticker),$(this.el).find("#active").remove(),this.initMatrix(),this.drawMyStage(),this.resetData(),$("#debug_area").empty().hide(),$(document).off("keydown",this._fnKeyEvent)},reqReady:function(){this.stop();var t=$(this.el);t.find("#start_btn").hide(),t.find("#ready_btn").hide(),t.find("#cancel_btn").show(),t.find("#stop_btn").hide(),this.oGameIo.emit("reqReady"),this.setGameStatus("ready")},resReady:function(t){if("ok"===t.sStatus);else if("game"===t.sStatus){var e=$(this.el);e.find("#start_btn").show(),e.find("#ready_btn").show(),e.find("#cancel_btn").hide(),e.find("#stop_btn").show()}else{var e=$(this.el);e.find("#start_btn").show(),e.find("#ready_btn").show(),e.find("#cancel_btn").hide(),e.find("#stop_btn").show(),alert("resReady에서 오류가 났습니다.")}},reqCancel:function(){var t=$(this.el);t.find("#start_btn").show(),t.find("#ready_btn").show(),t.find("#cancel_btn").hide(),t.find("#stop_btn").hide(),this.oGameIo.emit("reqCancel")},resCancel:function(t){if("ok"===t.sStatus);else if("game"===t.sStatus){var e=$(this.el);e.find("#start_btn").hide(),e.find("#ready_btn").hide(),e.find("#cancel_btn").show(),e.find("#stop_btn").hide(),alert("이미 게임이 시작되었습니다.")}else{var e=$(this.el);e.find("#start_btn").hide(),e.find("#ready_btn").hide(),e.find("#cancel_btn").show(),e.find("#stop_btn").hide(),alert("resCancel에서 오류가 났습니다.")}},makeNewBlock:function(){var t=this.model.get("oBlockCollection"),e=this.model.get("nextBlock").shift();if(this.isGameOver())return!1;this.model.set("nextBlock",[]);var i=this.model.get("nextBlock");i.push(this.model.getRandomRange());var n=t.at(e).clone();this.model.set("currentBlock",n),this.model.setBlockPosXY(4,-1),this.checkLevelUp()},moveDown:function(t){if(!this.checkGameOver()){var e=this.model.get("htBlockPos"),i=!1,n=this.Util.checkCollision(e,this.model.get("currentBlock"),"bottom",this.model.get("aMatrix"));return n?(t&&this.controlSound("lockdown","play"),this.model.setBlockToMatrix(this.model.get("currentBlock"),this.model.get("htBlockPos")),this.makeNewBlock(),i=!0):(e.nY++,this.model.set("htBlockPos",e)),this.clearFullLine(),this.debugMode&&(this.drawMyStage(),this.drawMovingBlock()),i}},clearFullLine:function(){var t=this.model.clearFullLine();this._addScoreBy(t)},_addScoreBy:function(t){if(t>0){var e=0;2>=this._nHardBlockPosY&&(e=50*(this._nHardBlockPosY+1)),this.model.plusScore(100*t+e)}},moveBlock:function(t){"left"===t?this.Util.checkCollision(this.model.get("htBlockPos"),this.model.get("currentBlock"),"left",this.model.get("aMatrix"))||this.model.get("htBlockPos").nX--:"right"===t&&(this.Util.checkCollision(this.model.get("htBlockPos"),this.model.get("currentBlock"),"right",this.model.get("aMatrix"))||this.model.get("htBlockPos").nX++),this.debugMode&&(this.drawMyStage(),this.drawMovingBlock())},setMatrix:function(t){this.model.setMatrix(t)},getMatrix:function(){return this.model.get("aMatrix")},initMatrix:function(){this.model.initMatrix()},getPosPixelByColor:function(t,e){return this.arColorPos[t]*e},rotateBlock:function(t){var e=this.Util.rotateBlockArray(t,this.model.get("currentBlock"),this.model.get("htBlockPos"),this.model.get("aMatrix"));this.model.set("currentBlock",e),this.debugMode&&(this.drawMyStage(),this.drawMovingBlock())},isGameOver:function(){for(var t=this.getMatrix(),e=0,i=1;this.model.get("nCols")+1>i;i++)1==t[0][i].nFlag&&e++;return e>0},checkGameOver:function(){return this.isGameOver()?($(this.el).find("#active").remove(),this.stopAnimationLoop(),this.setGameStatus("end"),$(document).off("keydown",this._fnKeyEvent),!0):!1},clearLongPress:function(){clearInterval(this.keyLongPressChecker),this.nLongPressCnt=0},resetBlockPos:function(t){return t=this.model.get("htBlockPos"),t.nY=-1,this.model.set("htBlockPos",t),t},moveHardDown:function(){this.clearLongPress(),this.controlSound("harddrop","play");var t=!1;this._nHardBlockPosY=this.model.get("htBlockPos").nY;for(var e=0,i=this.model.get("nRows");i>e;e++){if(t===!0){htBlockPos=this.resetBlockPos();break}var n=!1;t=this.moveDown(n)}},_onKeyAction:function(t){var e=t.keyCode;if("keydown"==t.type&&0===this.nLongPressCnt){this.htKeyState[t.keyCode||t.which]=!0,this.nLongPressCnt=1,clearInterval(this.keyLongPressChecker);var i=this;this.keyLongPressChecker=setInterval(function(){i.nLongPressCnt++,i.keyPressFlag=i.nLongPressCnt>5?!0:!1},400)}if("keyup"==t.type&&(this.htKeyState[t.keyCode||t.which]=!1,this.nLongPressCnt=0,clearInterval(this.keyLongPressChecker)),"keyup"===t.type)return!1;if("pause"===this.model.get("sGameStatus")&&16!==e)return!1;switch(e){case 32:this.moveHardDown();break;case 37:this.moveBlock("left");break;case 39:this.moveBlock("right");break;case 38:this.rotateBlock("right");break;case 40:this.moveDown(!0);break;case 90:this.rotateBlock("left");break;case 88:this.rotateBlock("right");break;default:}return!1},drawDebugStage:function(){for(var t=this.getMatrix(),e=[],i=t.length,n=t[0].length,o=0;i>o;o++){for(var s=0;n>s;s++)e.push('<div class="block">'+t[o][s].nFlag+"</div>");e.push('<div class="clear"></div>')}$("#debug_area").show().empty().append(e.join(""))}}),app.tetris.Game.WebGLView=Backbone.View.extend({defaults:{nWidth:0,nHeight:0,arCameraEye:[0,0,0],arCameraLookAt:[0,0,0],fAngleYZ:100,fAngleXZ:0,fCameraDistance:0,bCameraPerspective:!1,nFov:0,ctx:null,bWebGLAvailable:!1},isAvailWebGL:function(){return!!window.WebGLRenderingContext},initCanvas:function(){var t=this.$el[0];this.nWidth=this.$el.width(),this.nHeight=this.$el.height(),this.$el.attr("width",this.nWidth),this.$el.attr("height",this.nHeight),this.arCameraEye=[0,0,0],this.arCameraLookAt=[0,0,0],this.fAngleYZ=0,this.fAngleXZ=Math.PI/2,this.fCameraDistance=300,this.bCameraPerspective=!1,this.nFov=45;var e=["webgl","experimental-webgl","webkit-3d","moz-webgl"];this.ctx=null;for(var i=0;e.length>i;++i){try{this.ctx=t.getContext(e[i])}catch(n){break}if(null!=this.ctx)break}this.bWebGLAvailable=null==this.ctx?!1:!0,this.initResource(),this.initShader(),this.clear(),this.setEvents()},setEvents:function(){var t=this;this.forward=!1,this.startX=0,this._nMovedViewX=0,this._nMovedViewY=0;var e=function(t){if(this.mouseDownFlag){var e=i.width(),n=i.offset().left,o=i.offset().top,s=i.height();t=t.originalEvent.changedTouches?t.originalEvent.changedTouches[0]:t.originalEvent;var a=t.clientX-n-this._nMovedViewX,r=t.clientY-o-this._nMovedViewY,l=180*(a/e);this.fAngleXZ=l*Math.PI/180,l=90*(r/s),this.fAngleYZ=l*Math.PI/180,this._nViewX=a,this._nViewY=r}};this.flag=0,this.startX=350;var i=this.$el;i.mousewheel(function(e,i){return t.fCameraDistance+=10*i,!1});var n=$.proxy(e,this);i.on("mousedown touchstart",function(){t.mouseDownFlag=!0,$(document).on("touchmove mousemove",n)}),$(document).on("mouseup touchcancel touchend",$.proxy(function(){this.mouseDownFlag=!1,$(document).off("mousemove touchmove",n)},this))},initResource:function(){var t=this.ctx,e=[-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5];this.gl_VB_Position_Cube=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.gl_VB_Position_Cube),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW),this.gl_VB_Position_Cube.itemSize=3,this.gl_VB_Position_Cube.numItems=24,t.bindBuffer(t.ARRAY_BUFFER,null);var i=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];this.gl_VB_Color_Cube=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.gl_VB_Color_Cube),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW),this.gl_VB_Color_Cube.itemSize=4,this.gl_VB_Color_Cube.numItems=24,t.bindBuffer(t.ARRAY_BUFFER,null);var n=[0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1];this.gl_VB_Cordinate_Cube=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.gl_VB_Cordinate_Cube),t.bufferData(t.ARRAY_BUFFER,new Float32Array(n),t.STATIC_DRAW),this.gl_VB_Cordinate_Cube.itemSize=2,this.gl_VB_Cordinate_Cube.numItems=24,t.bindBuffer(t.ARRAY_BUFFER,null);var o=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];this.gl_IB_Cube=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.gl_IB_Cube),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(o),t.STATIC_DRAW),this.gl_IB_Cube.itemSize=1,this.gl_IB_Cube.numItems=36,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.gl_Tex_Cube=t.createTexture(),WebGLUtil.loadImage(t,this.gl_Tex_Cube,"res/img/mino_main2.png")},initShader:function(){var t=this.ctx;this.gl_Shader_RenderProgram=t.createProgram();var e=this.vertexShaderText,i=WebGLUtil.createShader(t,e,t.VERTEX_SHADER),n=this.fragmentShaderText,o=WebGLUtil.createShader(t,n,t.FRAGMENT_SHADER);return null==i||null==o?(alert("Shader can not compile"),!1):(t.attachShader(this.gl_Shader_RenderProgram,i),t.attachShader(this.gl_Shader_RenderProgram,o),t.deleteShader(i),t.deleteShader(o),t.linkProgram(this.gl_Shader_RenderProgram),t.getProgramParameter(this.gl_Shader_RenderProgram,t.LINK_STATUS)?(t.useProgram(this.gl_Shader_RenderProgram),this.gl_Attribute_VertexPosition=t.getAttribLocation(this.gl_Shader_RenderProgram,"aVertexPosition"),this.gl_Attribute_VertexColor=t.getAttribLocation(this.gl_Shader_RenderProgram,"aVertexColor"),this.gl_Attribute_VertexCordinate=t.getAttribLocation(this.gl_Shader_RenderProgram,"aVertexCordinate"),this.gl_Uniform_WorldMatrix=t.getUniformLocation(this.gl_Shader_RenderProgram,"uWorldMatrix"),this.gl_Uniform_ViewMatrix=t.getUniformLocation(this.gl_Shader_RenderProgram,"uViewMatrix"),this.gl_Uniform_ProjectionMatrix=t.getUniformLocation(this.gl_Shader_RenderProgram,"uProjectionMatrix"),this.gl_Uniform_Texture=t.getUniformLocation(this.gl_Shader_RenderProgram,"uTexture"),this.gl_Uniform_ModulateCordinate=t.getUniformLocation(this.gl_Shader_RenderProgram,"uModulateCordinate"),this.gl_Uniform_Color=t.getUniformLocation(this.gl_Shader_RenderProgram,"uColor"),t.useProgram(null),void 0):(alert("Could not initialize shaders"),!1))},initialize:function(){this.vertexShaderText=WebGLUtil.loadShader("res/shader/model.vs"),this.fragmentShaderText=WebGLUtil.loadShader("res/shader/model.fs"),this.i=0},drawBlock:function(t,e,i,n,o){var s=this.ctx;s.useProgram(this.gl_Shader_RenderProgram),s.enableVertexAttribArray(this.gl_Attribute_VertexPosition),s.enableVertexAttribArray(this.gl_Attribute_VertexColor),s.enableVertexAttribArray(this.gl_Attribute_VertexCordinate);var a=[this.fCameraDistance*Math.cos(this.fAngleYZ)*Math.cos(this.fAngleXZ),this.fCameraDistance*Math.sin(this.fAngleYZ),this.fCameraDistance*Math.cos(this.fAngleYZ)*Math.sin(this.fAngleXZ)];this.arCameraEye[0]=this.arCameraLookAt[0]+a[0],this.arCameraEye[1]=this.arCameraLookAt[1]+a[1],this.arCameraEye[2]=this.arCameraLookAt[2]+a[2];var r=mat4.create(),l=mat4.create(),c=mat4.create();mat4.identity(r),mat4.scale(r,[i,i,i],r),mat4.translate(r,[t,e,0],r),mat4.lookAt(this.arCameraEye,this.arCameraLookAt,[0,1,0],l),1==this.bCameraPerspective?mat4.perspective(this.nFov,this.nWidth/this.nHeight,.1,1e3,c):0==this.bCameraPerspective&&mat4.ortho(-this.nWidth/2,this.nWidth/2,-this.nHeight/2,this.nHeight/2,.1,1e3,c),s.uniformMatrix4fv(this.gl_Uniform_WorldMatrix,!1,r),s.uniformMatrix4fv(this.gl_Uniform_ViewMatrix,!1,l),s.uniformMatrix4fv(this.gl_Uniform_ProjectionMatrix,!1,c),1==this.gl_Tex_Cube.bIsLoaded&&(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.gl_Tex_Cube),s.uniform1i(this.gl_Uniform_Texture,0)),s.uniform4fv(this.gl_Uniform_ModulateCordinate,[.0625,1,.0625*n,0]),s.uniform4fv(this.gl_Uniform_Color,o),s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),1>o[3]?(s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.blendEquation(s.FUNC_ADD)):s.disable(s.BLEND),s.bindBuffer(s.ARRAY_BUFFER,this.gl_VB_Position_Cube),s.vertexAttribPointer(this.gl_Attribute_VertexPosition,this.gl_VB_Position_Cube.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this.gl_VB_Color_Cube),s.vertexAttribPointer(this.gl_Attribute_VertexColor,this.gl_VB_Color_Cube.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this.gl_VB_Cordinate_Cube),s.vertexAttribPointer(this.gl_Attribute_VertexCordinate,this.gl_VB_Cordinate_Cube.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.gl_IB_Cube),s.drawElements(s.TRIANGLES,this.gl_IB_Cube.numItems,s.UNSIGNED_SHORT,0),s.bindBuffer(s.ARRAY_BUFFER,null),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),s.bindTexture(s.TEXTURE_2D,null),s.disableVertexAttribArray(this.gl_Attribute_VertexPosition),s.disableVertexAttribArray(this.gl_Attribute_VertexColor),s.disableVertexAttribArray(this.gl_Attribute_VertexCordinate),s.useProgram(null)},clear:function(){var t=this.ctx;t.clearColor(0,0,0,0),t.viewport(0,0,this.nWidth,this.nHeight),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}}),app.tetris.Rules.BlockList={create:function(){var t=[];return t[0]=new app.tetris.Game.BlockModel({sColor:"yellow",sCode:"O",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]}),t[1]=new app.tetris.Game.BlockModel({sColor:"sky",sCode:"I",nAngle:0,aMatrix:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]]}),t[2]=new app.tetris.Game.BlockModel({sColor:"orange",sCode:"L",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,1],[0,1,0,0],[0,0,0,0]]}),t[3]=new app.tetris.Game.BlockModel({sColor:"blue",sCode:"J",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,1],[0,0,0,1],[0,0,0,0]]}),t[4]=new app.tetris.Game.BlockModel({sColor:"green",sCode:"S",nAngle:0,aMatrix:[[0,0,0,0],[0,0,1,1],[0,1,1,0],[0,0,0,0]]}),t[5]=new app.tetris.Game.BlockModel({sColor:"red",sCode:"Z",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,0],[0,0,1,1],[0,0,0,0]]}),t[6]=new app.tetris.Game.BlockModel({sColor:"purple",sCode:"T",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,1],[0,0,1,0],[0,0,0,0]]}),t}},function(){var t=Backbone.View.extend({el:"#_container #_menu_view",template:"menu",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.render(),app.tetris.Network.Model.on("change:nRegisterUser change:nConnectedUser",$.proxy(function(t){this.onChangeCount(t)},this))},onChangeCount:function(t){var e=this.$el.find("._conn_user_cnt");e.find("._con_user").html(t.get("nConnectedUser")),e.find("._reg_user").html(t.get("nRegisterUser")),e.removeClass("pulse").hide().addClass("pulse").show()},onClickMenu:function(t){var e=$(t.currentTarget).attr("data-navigate");return app.tetris.Router.navigate(e,{trigger:!0}),!1},show:function(){this.render(),this.$el.show(),this.$el.find("._welcome").addClass("animated").addClass("pulse"),this.$el.addClass("animated").removeClass("fadeOutUp").addClass("fadeInDown"),this.$el.find("._conn_user_cnt").removeClass("pulse").addClass("animated").addClass("pulse").show();var t=this;setTimeout(function(){t.myScroll&&t.myScroll.refresh()},200)},hide:function(){this.$el.addClass("animated").removeClass("fadeInDown").addClass("fadeOutUp")},render:function(){var t={sName:app.tetris.Account.Info.userId,nConnectedUser:app.tetris.Network.Model.get("nConnectedUser"),nRegisterUser:app.tetris.Network.Model.get("nRegisterUser")},e=app.tetris.TemplateManager.get(this.template,t);return this.$el.html(e),this.myScroll=new IScroll("#wrapper_scroll",{scrollX:!1,scrollY:!0,momentum:!0,click:!0}),this}});app.tetris.Menu.View=new t}(),app.tetris.init=function(t){app.tetris.config.setEnv(t||"development"),app.tetris.Game.Network.init(),app.tetris.Router=app.tetris.Router.getInstance(),app.tetris.Game.StageView=app.tetris.Game.StageView.getInstance(),app.tetris.Network.startSession(),app.tetris.ui.BackButton.setEvents(),Backbone.history.start();var e=Backbone.history.fragment?Backbone.history.fragment:!1;app.tetris.Router.navigate(e,{trigger:!0})},function(){var t=app.tetris,e=Backbone.Router.extend({routes:{login:"moveToStart",menu:"moveToMenu",single:"moveToSingleGame",multi:"moveToMultiGame",board:"moveToGameBoard",credit:"moveToCredit",logout:"moveToLogout","":"moveToStart"},execute:function(t,e){app.tetris.Account.Info.load();var i=Backbone.history.fragment;app.tetris.Account.Info.isAuthenticated()||"login"===i||app.tetris.Account.Network.connect(function(){app.tetris.Account.Network.io.emit("reqLogin",app.tetris.Account.Info.getAccount())}),t&&t.apply(this,e)},initialize:function(){this._welContainer=$("#_container"),this._hideAllScreens()},_hideAllScreens:function(){this._welContainer.find("#_dimmed_section").hide(),this._welContainer.find("._screen").hide(),this._welContainer.removeClass("animated").removeClass("fadeInDown"),t.ui.Header.View.hide(),t.ui.Footer.View.hide(),t.ui.BackButton.hide()},moveToStart:function(){this._hideAllScreens(),t.Account.View.show()},moveToLogout:function(){app.tetris.Account.Info.clear(),this.navigate("login",{trigger:!0})},moveToSingleGame:function(){this._hideAllScreens(),t.ui.BackButton.show(),t.Game.StageView.setType("single"),t.Game.StageView.show()},moveToMultiGame:function(){this._hideAllScreens(),t.ui.BackButton.show(),t.Game.StageView.setType("multi"),t.Game.StageView.show()},moveToGameBoard:function(){this._hideAllScreens(),t.Board.init(),t.Board.View.show(),t.ui.Header.View.changeTitle("GameBoard").show(),t.ui.Footer.View.show(),t.ui.BackButton.show()},moveToCredit:function(){this._hideAllScreens(),t.Credit.View.show(),t.ui.Header.View.changeTitle("Credit").show(),t.ui.BackButton.show()},moveBack:function(){window.history.back()},moveToMenu:function(){this._hideAllScreens(),t.Menu.View.show()}});app.tetris.Router={_oInstance:null,getInstance:function(){return null===this._oInstance&&(this._oInstance=new e),this._oInstance}}}();