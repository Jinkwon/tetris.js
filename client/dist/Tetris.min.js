/*! Tetris - v0.1.0 - 2014-05-17
* https://github.com/Jinkwon/tetris.js
* Copyright (c) 2014 LeeJinKwon; Licensed MIT */
function meta(t,e){document.write('<meta name="'+t+'" content="'+e+'">')}var app=app?app:{};app.tetris=app.tetris?app.tetris:{},app.tetris.Game={},app.tetris.Board={},app.tetris.Menu={},app.tetris.Rules={},app.tetris.Util={},app.tetris.Account={},app.tetris.ui={},app.tetris.ui.Footer={},app.tetris.ui.Header={},app.tetris.ui.Option={},app.tetris.Network={},app.tetris.Credit={},app.tetris.Webgl={},app.tetris.config={sName:"Tetris",sMode:"development",sHost:""};var sSrvUrl="";switch(app.tetris.config.sMode){case"production":sSrvUrl="";break;case"staging":sSrvUrl="http://srv.bdyne.net:8888";break;default:sSrvUrl="http://"+document.location.hostname+":8888"}app.tetris.config.sHost=sSrvUrl,app.tetris.config.sAccountUrl=sSrvUrl+"/account",app.tetris.config.sSessionUrl=sSrvUrl+"/session",app.tetris.config.sMonitorUrl=sSrvUrl+"/monitor",app.tetris.config.sGameUrl=sSrvUrl+"/game",app.tetris.config.sChatUrl=sSrvUrl+"/chat",app.tetris.TemplateManager={templates:{},get:function(t,e){var i=this.templates[t];if(i){var n=_.template(i,e);return n}i=$.ajax({url:"./views/"+t+".html",async:!1}).responseText,this.templates[t]=i;var n=_.template(i,e);return n}},app.mobile={},app.mobile.metaInit=function(){meta("expires","-1"),meta("Cache-Control","No-Cache"),meta("Pragma","No-Cache"),meta("viewport","initial-scale=1.0, width=device-width, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"),meta("format-detection","address=no,telephone=no"),meta("apple-mobile-web-app-capable","yes"),meta("apple-mobile-web-app-status-bar-style","white"),meta("apple-touch-fullscreen","yes")},app.tetris.Network.init=function(t){var e,i,n,t=t?t:{},o="",s="",a="";iOS=!1;var r=function(){iOS?t.fRunLogin&&t.fRunLogin():window.location.href="login.html"},l=function(){h(),c()},h=function(){i=io.connect(app.tetris.config.sGameUrl),i.on("connect",function(){var t={sEmpNo:o,sEmpNm:s,sDeptNm:a};i.emit("reqJoin",t)}).on("disconnect",function(){i=io.connect(app.tetris.config.sGameUrl)}).on("resJoin",function(t){"ok"===t.sStatus?$("#ready_btn").show():"exist"===t.sStatus?(o=$.cookie("sEmpNo"),s=$.cookie("sEmpNm"),a=$.cookie("sDeptNm"),i.emit("reqReJoin",htReq)):"game"===t.sStatus?alert("이미 게임이 시작하였습니다."):(alert("서버와 접속이 원활하지 않습니다."),r())}).on("pushGameDone",function(){$("#ready_btn").show()}).on("resReady",function(t){e.resReady(t)}).on("resCancel",function(t){e.resCancel(t)}).on("pushStart",function(){e.start(!0)}).on("pushStop",function(){e.stop(!0)})},c=function(){n=io.connect(app.tetris.sChatUrl),n.on("connect",function(){n.emit("sendJoin",{sEmpNo:o,sEmpNm:s,sDeptNm:a})})},d=function(t){e=t};return l(),{oGameIo:i,oChatIo:n,bindViewer:d}},app.tetris.Network.oSessionIo=io.connect(app.tetris.config.sSessionUrl);var oSessionIo=app.tetris.Network.oSessionIo;oSessionIo.on("resConnectionCount",function(t){console.log(t),app.tetris.Network.Model.set({nConnectedUser:t.nConnectedUser,nRegisterUser:t.nRegisterUser})}),oSessionIo.on("connect",function(){$("#selectable").empty(),oSessionIo.emit("reqConnectionCount")}),function(){var t=Backbone.Model.extend({defaults:{nConnectedUser:0,nRegisterUser:0},initialize:function(){}});app.tetris.Network.Model=new t}(),app.tetris.Util.leadingSpaces=function(t,e){var i="";if(t=""+t,e>t.length)for(var n=0;e-t.length>n;n++)i+="0";return i+t},app.tetris.Util.makeGuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=0|16*Math.random(),i="x"==t?e:8|3&e;return i.toString(16)})},function(){for(var t=0,e=["webkit","moz"],i=0;e.length>i&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var i=(new Date).getTime(),n=Math.max(0,16-(i-t)),o=window.setTimeout(function(){e(i+n)},n);return t=i+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}();var WebGLUtil={};WebGLUtil.createShader=function(t,e,i){var n=t.createShader(i);if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){for(var o=t.getShaderInfoLog(n);o.length>1&&32>o.charCodeAt(o.length-1);)o=o.substring(0,o.length-1);return alert(o),null}return n},WebGLUtil.loadImage=function(t,e,i){var n={};e.bIsLoaded=!1,n.img=new Image,n.img.src=i,n.img.onload=function(){t.bindTexture(t.TEXTURE_2D,e),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n.img),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null),e.bIsLoaded=!0},n.img.onerror=function(){alert("error load texture")}},WebGLUtil.loadShader=function(t){var e=null;return $.ajax({async:!1,url:t,success:function(t){e=t},dataType:"text"}),e},app.tetris.ui.BackButton={setEvents:function(){$(document).on("click","._close",$.proxy(function(t){this._clearAnimationClass($(t.currentTarget)),$(t.currentTarget).addClass("bounceIn").show(),window.history.back()},this))},show:function(){var t=$("#_container").find("._close");this._clearAnimationClass(t),t.show().addClass("rotateIn")},hide:function(){var t=$("#_container").find("._close");"none"!==t.css("display")?(this._clearAnimationClass(t),t.show().addClass("bounceOut").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){t.hide()})):(this._clearAnimationClass(t),t.hide())},_clearAnimationClass:function(t){t.removeClass("bounceIn").removeClass("rotateIn")}},function(){var t=Backbone.View.extend({el:"#_container #_footer",template:"ui/footer",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.render()},onClickMenu:function(){return!1},show:function(){this.$el.show()},hide:function(){this.$el.hide()},render:function(){var t=app.tetris.TemplateManager.get(this.template,{});return this.$el.html(t),this}});app.tetris.ui.Footer.View=new t}(),function(){var t="HEADER",e=Backbone.View.extend({el:"#_container #_header",template:"ui/header",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.sTitle=t,this.setEvents(),this.render()},setEvents:function(){this.model.bind("change",$.proxy(this.render,this))},onClickMenu:function(){return!1},show:function(){return this.render(),this.$el.addClass("animated").addClass("fadeInUp").show(),this},hide:function(){this.$el.hide(),this.sTitle=t},changeTitle:function(t){return this.sTitle=t,this},render:function(){var t={sTitle:this.sTitle,nConnectedUser:this.model.get("nConnectedUser")},e=app.tetris.TemplateManager.get(this.template,t);return this.$el.html(e),this}});app.tetris.ui.Header.View=new e({model:app.tetris.Network.Model})}(),app.tetris.ui.Option.View=Backbone.View.extend({el:"#_container #_option",template:"ui/option",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.render()},onClickMenu:function(){return!1},render:function(){var t=app.tetris.TemplateManager.get(this.template,{});return this.$el.html(t).show(),this}}),function(){var t=function(){this.userId="",this.passwd="",this.bAvail=!1};t.prototype={_listeners:[],setAccount:function(t,e){this.userId=t,this.passwd=e},getAccount:function(){return{userId:this.userId,passwd:this.passwd}},on:function(t,e){return this.listeners=_.filter(this.listeners,function(e){return e.sEvent!==t}),this.listeners.push({fn:e,sEvent:t}),this},save:function(){""!==this.userId&&""!==this.passwd&&window.localStorage.setItem("account",JSON.stringify({userId:this.userId,passwd:this.passwd}))},load:function(){var t=window.localStorage.getItem("account"),e=JSON.parse(t)||{userId:"",passwd:""};this.userId=e.userId,this.passwd=e.passwd},clear:function(){window.localStorage.removeItem("account"),this.userId="",this.passwd="",this.bAvail=!1},broadcast:function(t){return _.each(this.listeners,function(e){e.sEvent===t&&e.fn()}),this},isAuthenticated:function(){return this.bAvail}},app.tetris.Account.Info=new t}(),app.tetris.Account.Network={},app.tetris.Account.Network.connect=function(t){app.tetris.Account.Network.io||(app.tetris.Account.Network.io=io.connect(app.tetris.config.sAccountUrl),app.tetris.Account.Network.io.on("connection",function(){t&&t()}).on("error",function(){alert("Cannot connect to Server")}).on("reconnect_failed",function(){console.log("reconnect_failed")}).on("connect_failed",function(t){console.log(t)}).on("resLogin",function(t){app.tetris.Account.Info.bAvail=t.bAvail,app.tetris.Account.Info.bAvail?app.tetris.Account.Info.broadcast("onSuccessLogin"):app.tetris.Account.Info.broadcast("onFailLogin")}).on("resJoin",function(t){return t.bAvail===!1?(alert(t.sMessage),void 0):(app.tetris.Account.Info.on("onSuccessLogin",function(){app.tetris.Account.Info.save(),app.tetris.Menu.View.render(),app.tetris.Router.navigate("menu",{trigger:!0})}),app.tetris.Account.Network.io.emit("reqLogin",app.tetris.Account.Info.getAccount()),void 0)})),app.tetris.Account.Network.io.socket.connected===!1&&app.tetris.Account.Network.io.socket.connecting===!1?app.tetris.Account.Network.io.socket.connect():t&&t()},function(){var t=Backbone.View.extend({el:"#_container #_start_view",template:"start",events:{"click ._splash_section":"_onClickSplash","click ._join_btn":"_onClickJoin","click ._login_btn":"_onClickLogin"},initialize:function(){this.render()},assignElements:function(){this.welPw=this.$el.find("._pw"),this.welPwRe=this.$el.find("._pw_re"),this.welId=this.$el.find("._id")},_checkLoginValidation:function(){return""===this.welId.val().trim()?(alert("Please insert Id"),this.welId.focus(),!1):""===this.welPw.val().trim()?(alert("Please insert Password"),this.welPw.focus(),!1):!0},_checkJoinValidation:function(){return this._checkLoginValidation()?this.welPw.val()!==this.welPwRe.val()?(alert("Not same password"),!1):!0:!1},_onClickLogin:function(){this._checkLoginValidation()&&app.tetris.Account.Network.connect($.proxy(function(){this._updateAccount(),this._setAccountEvents(),app.tetris.Account.Network.io.emit("reqLogin",app.tetris.Account.Info.getAccount())},this))},_onClickJoin:function(){return"none"===this.welPwRe.css("display")?(this.welPwRe.show().css("height",0).animate({height:this.welPw.outerHeight()+"px"},250,"easeOutBounce"),void 0):(this._checkJoinValidation()&&app.tetris.Account.Network.connect($.proxy(function(){this._updateAccount(),this._setAccountEvents(),app.tetris.Account.Network.io.emit("reqJoin",app.tetris.Account.Info.getAccount())},this)),void 0)},_updateAccount:function(){var t=this.$el.find("._id").val(),e=this.$el.find("._pw").val();app.tetris.Account.Info.setAccount(t,e)},_setAccountEvents:function(){app.tetris.Account.Info.on("onFailLogin",function(){alert("Invalid Id or Password")}),app.tetris.Account.Info.on("onSuccessLogin",function(){app.tetris.Account.Info.save(),app.tetris.Router.navigate("menu",{trigger:!0})})},_onClickSplash:function(){return"none"!==this.$el.find("#_login_form").css("display")?(this._resetDisplay(),void 0):(this.$el.find("._start_btn").removeClass("flipInY").addClass("fadeOutUp"),app.tetris.Account.Info.isAuthenticated()?app.tetris.Router.navigate("menu",{trigger:!0}):(this.hide(),this.$el.find("#_login_form").addClass("flipInX").show()),!1)},hide:function(){this.$el.find("._title").addClass("fadeOutUp").show()},_updateInputs:function(){var t=app.tetris.Account.Info.getAccount();this.$el.find("._id").val(t.userId),this.$el.find("._pw").val(t.passwd),this.$el.find("._pw_re").val(t.passwd),this.welPwRe.hide()},_playShowAnimation:function(){this.$el.find("._start_btn").removeClass("flipOutX").removeClass("flipOutY").addClass("flipInY"),this.$el.find("._title").removeClass("fadeOutUp").addClass("flipInX")},_hideLoginForm:function(){this.$el.find("#_login_form").hide()},_resetDisplay:function(){this._updateInputs(),this._hideLoginForm(),this._playShowAnimation()},show:function(){this._resetDisplay(),this.$el.show()},render:function(){var t=app.tetris.TemplateManager.get(this.template,{});return this.$el.html(t),this.assignElements(),this}});app.tetris.Account.View=new t}(),app.tetris.Board.init=function(t){if(!app.tetris.Board.bInitialized){var e=io.connect(app.tetris.config.sMonitorUrl),i=0,n=[];navigator.userAgent.match(/(iPad|iPhone|iPod)/i)?!0:!1;var o=function(){n=[],$("#_watch").empty(),$("#_gamePeople .ui-selected").each(function(){var t=$(this).attr("id").replace("_gp_",""),e=$(this).text();n.push(t);var i=[];i.push('<li class="other_user">'),i.push('<canvas id="_watch_'+t+'" width="100" height="210" class="other_user_canvas"></canvas>'),i.push('<div id="_info_'+t+'" class="info">'+e+"</div>"),i.push("</li>"),$("#_watch").append(i.join(""))}),e.emit("sendSelectedGamePeople",n)},s=function(){e.on("resAdmin",function(t){"ok"===t?$("#_start").show():"game"===t&&$("#_stop").show()}),e.on("pushPeopleInfo",function(t){var e=t.aConnectedPeople||[],n=t.aGamePeople||[],s=e.length||0;i=n.length||0,this.bRealGame=t.bRealGame,$("#_currentConnectedPeople").text(s),$("#_currentGamePeople").text(i);for(var a=[],r=0;s>r;r++)a.push('<li id="_cp_'+e[r].sEmpNo+'">'+e[r].sEmpNm+"</li>");$("#_connectedPeople").html(a.join(""));for(var a=[],r=0;i>r;r++)this.bRealGame?(nScore=void 0===n[r].nScore?0:n[r].nScore,a.push('<li id="_gp_'+n[r].sEmpNo+'">'+n[r].sEmpNm+" - "+nScore+"점</li>")):a.push('<li id="_gp_'+n[r].sEmpNo+'">'+n[r].sEmpNm+"</li>");$("#_gamePeople").html(a.join("")).selectable({selected:function(){o()},stop:function(){o()}})}),e.on("pushGameInfo",function(t){$("#_info_"+t.sEmpNo).text(t.sEmpNm+" - "+t.nScore+"점")})},a=function(){$("#selectable").selectable(),s(),$("#_join").show(),$("#_start").on("click",function(){return 0===i?(alert("There is no ready people for gaming.\nTell people to be ready."),void 0):(confirm("Do you really want to start the game?")&&($(this).hide(),$("#_stop").show(),e.emit("sendStart"),this.bRealGame=!0),void 0)}),$("#_stop").on("click",function(){$(this).hide(),$("#_start").show(),e.emit("sendStop")}),app.tetris.Board.bInitialized=!0};a()}},function(){var t=Backbone.View.extend({el:"#_container #_gameboard_view",template:"board",defaults:{oWebGLView:{},bWebGLOn:!1},events:{"click._move_to_menu":"moveToMenu"},initialize:function(){this.render()},show:function(){this.$el.hide().stop().fadeIn(300)},hide:function(){this.$el.hide()},moveToMenu:function(){app.tetris.Router.navigate("menu",{trigger:!0})},render:function(){return app.tetris.TemplateManager.get(this.template,{},$.proxy(function(t){this.$el.html(t)},this)),this}});app.tetris.Board.View=new t}(),function(){var t=Backbone.View.extend({el:"#_container #_credit_view",template:"credit",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.setEvents(),this.render()},setEvents:function(){},onClickMenu:function(){return!1},show:function(){this.$el.show(),this.$el.addClass("animated").removeClass("fadeInUp").addClass("fadeInDown")},hide:function(){this.$el.addClass("animated").removeClass("fadeInDown").addClass("fadeInUp")},render:function(){var t={},e=app.tetris.TemplateManager.get(this.template,t);return this.$el.html(e),this}});app.tetris.Credit.View=new t}(),app.tetris.Game.BlockModel=Backbone.Model.extend({defaults:function(){return{sColor:"",sCode:"",nAngle:0,aMatrix:[]}}}),app.tetris.Game.init=function(t){t=t?t:{},$("#main"),$("#login"),$("#game"),$("#gameboard"),$("#about");var e=[];return{on:function(t,i){e.push({sEvent:t,fn:i})}}},app.tetris.Game.Model=Backbone.Model.extend({defaults:function(){return{nScore:0,sGameStatus:"stop",nBlockPixel:null,aBlocks:null,nNumber:2,nCols:0,nRows:0,sGuid:"",aMatrix:[],nGameStartTime:0,oBlockCollection:{},htBlockPos:{nX:0,nY:0}}},initialize:function(){this.set({nScore:0,htBlockPos:{nX:5,nY:0},nCols:10,nRows:20,nBlockPixel:22}),this.set("sGuid",app.tetris.Util.makeGuid());var t=Backbone.Collection.extend({model:app.tetris.Game.BlockModel}),e=new t;e.add(app.tetris.Rules.arBlockList),this.set("oBlockCollection",e),this.initMatrix()},plusScore:function(t){var e=this.get("nScore");this.set("nScore",e+100*t)},setBlockPosXY:function(t,e){this.set({htBlockPos:{nX:t,nY:e}})},getRandomRange:function(){var t=0,e=this.get("oBlockCollection").length-1;return Math.floor(Math.random()*(e-t+1)+t)},initMatrix:function(){for(var t=[],e=this.get("nCols"),i=this.get("nRows"),n=0;i+2>n;n++){t[n]=[];for(var o=0;e+2>o;o++)t[n][o]=0==o||o==e+1||n>i?{nFlag:1}:{nFlag:0}}this.setMatrix(t)},setMatrix:function(t){this.set("aMatrix",t)},getMatrix:function(){return this.get("aMatrix")}}),function(){var t=Backbone.View.extend({el:"#_container #_single_view",template:"stage/stage.mobile",initialize:function(){this.arColorPos={red:1,orange:2,yellow:3,green:4,sky:5,blue:6,purple:7,sand:8,leaf:9,brown:10,leaf2:11,sky2:12,sand2:13,stone:14},this.focusMenu("tip"),this.model=new app.tetris.Game.Model,this._initTimer(),this.model.bind("change:sGameStatus",this.watchGameStatus,this),this.model.bind("change:htBlockPos",this.onBlockChange,this),this.setEvents(),this.render()},onBlockChange:function(){this.drawNextBlock()},drawNextBlock:function(){var t=this.model.get("oBlockCollection"),e=this.model.get("nextBlock")[0],i=this.getBlockString(t.at(e).get("aMatrix"),t.at(e).get("sColor"),16,"next");if($(".next_block_container").empty().append(i),this.drawNextGroupBlock){$(".next_group_block_container").empty();for(var n=0;3>n;n++){e=this.model.get("nextBlock")[n+1];var i=this.getBlockString(t.at(e).get("aMatrix"),t.at(e).get("sColor"),12,"next_"+n);$(".next_group_block_container").append(i+'<div style="clear:both;height:43px;"></div>')}}},getPosPixelByColor:function(t,e){return this.arColorPos[t]*e},getBlockString:function(t,e,i,n){for(var o,s=['<div class="single_block" style="clear:both;" id="'+n+'">'],a=0;t.length>a;a++){for(var r=0;t[a].length>r;r++)1==t[a][r]?(o=this.getPosPixelByColor(e,i),s.push('<div class="fill_block_'+i+'" style="width:'+i+"px;height:"+i+"px;background-position:-"+o+'px 0;"></div>')):s.push('<div class="empty_block" style="width:'+i+"px;height:"+i+'px;"></div>');s.push('<div class="clear"></div>')}return s.push("</div><br>"),s.join("")},render:function(){var t=app.tetris.TemplateManager.get(this.template,{});return this.$el.html(t),this},show:function(){this.$el.show(),this.oGameView=new app.tetris.Game.View({el:"#single_game_area",model:this.model,bEventBind:!0,bUseWebGL:!0}),this.oGameView2=new app.tetris.Game.View({el:"#other_1_game_area",model:new app.tetris.Game.Model,bEventBind:!0,bUseWebGL:!0}),this.oGameView3=new app.tetris.Game.View({el:"#other_2_game_area",model:new app.tetris.Game.Model,bEventBind:!0,bUseWebGL:!1}),setInterval(function(){$("#other_1_game_area").parent().removeClass("tada").hide().addClass("tada").show()},2e3),setInterval(function(){$("#other_2_game_area").parent().removeClass("tada").hide().addClass("tada").show()},3e3);var t=$(this.$el);this._setGameEvents(t)},excuteTick:function(){var t=this.nGameStartTime;t+=1e3;var e=new Date(t),i=app.tetris.Util.leadingSpaces(e.getMinutes(),2),n=app.tetris.Util.leadingSpaces(e.getSeconds(),2);this.drawTime(i,n),this.nGameStartTime=t,this.model.set("nGameStartTime",t)},drawTime:function(t,e){var i=$(".time_hour li").attr("class","").addClass("hold_num"),n=$(".time_min li").attr("class","").addClass("hold_num");$(i[0]).addClass("n"+t.charAt(0)),$(i[1]).addClass("n"+t.charAt(1)),$(n[0]).addClass("n"+e.charAt(0)),$(n[1]).addClass("n"+e.charAt(1))},_initTimer:function(){this.drawTime("00","00"),this.stopTimer()},startTimer:function(){var t=this;this.nGameStartTime=this.model.get("nGameStartTime"),this.stopTimer(),this.timer=setInterval(function(){t.excuteTick()},1e3)},stopTimer:function(){clearTimeout(this.timer)},watchGameStatus:function(){var t=this.model.get("sGameStatus");"start"===t?(this._initTimer(),this.startTimer()):"play"===t?($(".field .pause").remove(),this.startTimer()):"pause"===t?(this.stopTimer(),this.createDimmedLayer("Pause")):"stop"===t?(this._initTimer(),this.createDimmedLayer("Hello TETRIS")):"ready"===t?this.createDimmedLayer("Ready"):"game"===t?this.createDimmedLayer("Already Started"):"end"===t?this.createDimmedLayer("Game Over"):this.stopTimer()},logChat:function(t){var e=$(".chat_area").html();$(".chat_area").html(e+t+"<br>"),$(".chat_area").scrollTop($(".chat_area")[0].scrollHeight)},focusMenu:function(t){$(".tip_btn, .option_btn, .map_btn, .key_btn").css("background-position",""),"tip"===t?$(".tip_btn").css("background-position","-228px 0"):"option"===t?$(".option_btn").css("background-position","-224px 0"):"map"===t?$(".map_btn").css("background-position","-224px 0"):$(".key_btn").css("background-position","-224px 0")},_setGameEvents:function(t){t.find("#start_btn").bind("click",$.proxy(this.oGameView.start,this.oGameView)),t.find("#debug_btn").bind("click",$.proxy(this.oGameView.debugStart,this.oGameView)),t.find("#stop_btn").bind("click",$.proxy(this.oGameView.stop,this.oGameView)),t.find("#ready_btn").bind("click",$.proxy(this.oGameView.reqReady,this.oGameView)),t.find("#cancel_btn").bind("click",$.proxy(this.oGameView.reqCancel,this.oGameView)),$("#start_touch").bind("click",$.proxy(this.oGameView.start,this.oGameView))},setEvents:function(){var t=this;$(".chat_input").on("keydown",function(e){13===e.keyCode&&""!==$(this).val()&&(t.logChat("me : "+$(this).val()),$(this).val(""))}),$(".pop_btn").on("click",function(){var e=RegExp("^(.*)_btn","ig"),i=e.exec($(this).attr("id"))[1];t.focusMenu(i)});var e=$(this.$el);e.find("#ssamdi").on("click",$.proxy(function(){this.bWebGLOn=this.bWebGLOn===!0?!1:!0},this.oGameView)),e.find("#fullscreen_btn").bind("click",function(){var t=document.documentElement,e=t.requestFullScreen||t.webkitRequestFullScreen||t.mozRequestFullScreen;e.call(t)});var t=this.oGameView;e.find("#fullscreen_btn").bind("click",function(){if(1==t.bFullScreen)t.bFullScreen=!1;else{var e=document.documentElement,i=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen;i.call(e),t.bFullScreen=!0}})},createDimmedLayer:function(t){$(".field .pause").remove(),$("#_dimmed_section").prepend('<div class="pause" style="z-index:50;width:100%;height:100%;background-color:rgba(0,0,0,.7);position:absolute;color:#FFF;font-size:27px;font-family:Tahoma;"><div style="margin:auto;width:100%;height:25px;text-align:center;margin-top:200px;">'+t+"</div></div>")}});app.tetris.Game.StageView=new t}(),app.tetris.Game.View=Backbone.View.extend({defaults:{oWebGLView:{},bWebGLOn:!0},initialize:function(t){this.render(),this.oWebGLView=new app.tetris.Game.WebGLView({el:this.$el.find("._tetris_webgl_canvas")}),this.oUIView=t.oUIView,this.oGameIo=t.oGameIo||{},this.bEventBind=t.bEventBind,this._fnKeyEvent=$.proxy(this._onKeyAction,this),this.initResources(),void 0!==this.model&&(this.resetData(),this.initCanvas(),this.bEventBind&&(this.bindModelEvents(),this.bindEvents()),this.drawMyStage(),this.renderDOM(),this.start()),this.bWebGLOn=t.bUseWebGL?t.bUseWebGL:!1,this.bFullScreen=!1,this.bEventBind&&this.setTouchEvents()},render:function(){this.$el.html('<canvas class="_tetris_webgl_canvas" width="220" height="448" style="width:100%;height:100%;position:absolute;z-index:10;left:0px;display:block;"></canvas><canvas class="_tetris_origin_canvas" width="220" height="448" style="width:100%;height:100%;"> </canvas>')},resetData:function(){this.nTickCnt=0,this.tickTime=35,this.nLogicTickCnt=0,this.nLogicSpeed=1500,this.nLongPressCnt=0,this.level=1,this.model.set("nGameStartTime",0),this.model.set("nScore",0),this.initMatrix()},initResources:function(){this.blockImg=[],this.blockImg[22]=new Image,this.blockImg[22].src="./res/img/mino_main.png",this.blockImg[10]=new Image,this.blockImg[10].src="./res/img/mino_sub.png",this.arColorPos={red:1,orange:2,yellow:3,green:4,sky:5,blue:6,purple:7,sand:8,leaf:9,brown:10,leaf2:11,sky2:12,sand2:13,stone:14},this.initAudio()},initAudio:function(){this.htSound={harddrop:new Howl({urls:["../res/sound/TE_SE_harddrop.mp3"],volume:.3}),softdrop:new Howl({urls:["../res/sound/TE_SE_softdrop.mp3"],volume:.3}),lockdown:new Howl({urls:["../res/sound/TE_SE_lockdown.mp3"],volume:.3})}},controlSound:function(t,e){return this.htSound[t]?("play"===e?this.htSound[t].play():"stop"===e&&this.htSound[t].pause(),void 0):!1},bindModelEvents:function(){this.model.bind("change:nScore",this.renderDOM,this)},bindEvents:function(){$(this.el),this.X=0;var t=this;this.forward=!1,this.startX=0;var e=function(e){if(t.mouseDownFlag){var i=e.clientX-$(this).offset().left,n=$(this).width(),o=180*(i/n);t.oWebGLView.fAngleXZ=o*Math.PI/180;var s=e.clientY-$(this).offset().top,a=$(this).height(),o=90*(s/a);t.oWebGLView.fAngleYZ=o*Math.PI/180}};this.flag=0,this.startX=350;var i=this.$el.find("._tetris_webgl_canvas");i.mousewheel(function(e,i){return t.oWebGLView.fCameraDistance+=10*i,!1}),i.on("mousedown",function(){t.mouseDownFlag=!0,$(this).off("mousemove",e),$(this).on("mousemove",e)}),$(document).on("mouseup",function(){t.mouseDownFlag=!1,i.off("mousemove",e)})},renderDOM:function(){var t=this.model.get("nScore");$(".score").empty().html(t)},drawGhostBlock:function(){for(var t=this.model.get("htBlockPos"),e=0,i=0;35>i;i++)if(e=t.nY+i,this.checkCollision({nX:t.nX,nY:t.nY+i},this.aBlock,"bottom")){this.drawMovingBlock(this.aBlock,{nX:t.nX,nY:e},!0);break}},drawMovingBlock:function(t,e,i){var n,o,s,e=e||this.model.get("htBlockPos"),t=t||this.aBlock,a=this.ctx.stage;if(void 0!==t)for(var r=0;t.length>r;r++)for(var l=0;t[r].length>l;l++)s=!1,1===t[r][l]&&(sBlockColor=this.sBlockColor,s=!0),this.debugMode&&s===!1&&(sBlockColor="stone",s=!0),s&&(this.oWebGLView.isAvailWebGL(),n=l+e.nX-1,o=r+e.nY,this.drawBlock(a.ctx,sBlockColor,a.nBlockSize,n,o,i?.2:1))},drawMyStage:function(){var t=this.getMatrix(),e=this.ctx.stage;this.drawStage(e,t),this.debugMode&&this.drawDebugStage()},drawOtherStage:function(t,e){var i=this.ctx.others[t];try{e.length>0&&this.drawStage(i,e,10)}catch(n){}},drawStage:function(t,e,i){if(0!==e.length){var n=e.length,o=e[0].length,s=t.ctx,a=t.nBlockSize;this.clearScreen(t);for(var r=0;n>r;r++)for(var l=0;o>l;l++)if(1===e[r][l].nFlag){var h=e[r][l].sColor;this.drawBlock(s,h,a,l-1,r,1,i)}}},drawBoardStage:function(t,e){var i=this.getOriginCanvasObject();this.drawStage(i,e,0)},drawBlock:function(t,e,i,n,o,s,a){if(void 0===e)return!1;if(void 0===t)return!1;var r=this.bWebGLOn;if(this.ctx&&t==this.ctx.stage.ctx&&void 0!==this.oWebGLView&&(r=this.oWebGLView.isAvailWebGL()&&this.bWebGLOn===!0?!0:!1),r){var l=this.getMatrix(),h=l.length,c=l[0].length,d=(c-1)*i/2-22,u=(h+1)/2*i+5,m=0;this.oWebGLView.bCameraPerspective=!0,this.oWebGLView.arCameraLookAt=[d,u,m],this.oWebGLView.drawBlock(n,h-o,i,this.arColorPos[e],[1,1,1,s])}else{void 0===a&&(a=14);var p=this.getPosPixelByColor(e,i);t.globalAlpha=s,t.drawImage(this.blockImg[i],p,0,i,i,n*i,o*i-a,i,i),t.globalAlpha=1}},clearScreen:function(t){return t.ctx.clearRect(0,0,t.nWidth,t.nHeight),void 0===this.ctx?null:(t.ctx==this.ctx.stage.ctx&&void 0!==this.oWebGLView&&this.oWebGLView.isAvailWebGL()&&this.oWebGLView.clear(),void 0)},getOriginCanvasObject:function(){return this.getCanvasObjectBy("canvas")},getCanvasObjectBy:function(t){var e=null;switch(t){case"canvas":e=this.$el.find("._tetris_origin_canvas")[0]}var i=$(e).hasClass("game_area")?this.model.get("nBlockPixel"):10;return null===e?!1:{elCanvas:e,ctx:e.getContext("2d"),nWidth:e.width,nHeight:e.height,nBlockSize:i}},initCanvas:function(){this.ctx={stage:this.getOriginCanvasObject(),others:[]},this.nWidth=this.ctx.stage.width,this.nHeight=this.ctx.stage.height,this.oWebGLView.isAvailWebGL()&&(this.oWebGLView.initCanvas(),this.oWebGLView.fAngleYZ=0*(Math.PI/180),this.oWebGLView.fAngleXZ=90*(Math.PI/180),this.oWebGLView.fCameraDistance=300)},setGameStatus:function(t){this.model.set("sGameStatus",t),"start"===t&&(this.debugMode=!1,$("#debug_area").empty().hide(),$(".pause").remove())},setKeyEvents:function(){this.htKeyState={},$(document).unbind("keydown keyup",this._fnKeyEvent).bind("keydown keyup",this._fnKeyEvent)},setTouchEvents:function(){$(".jpad").on("touchstart mousedown",$.proxy(function(t){if(t.stopPropagation(),t.preventDefault(),"play"!==this.getGameStatus())return!1;if(t.handled!==!0){var e=$(t.currentTarget).attr("id");"down"===e?this.moveDown(!0):"right"===e?this.moveBlock("right"):"left"===e?this.moveBlock("left"):"up"===e?this.rotateBlock("right"):"harddown"===e&&this.moveHardDown(),t.handled=!0}return!1},this)),$("#game_area").on("hold tap swipe",$.proxy(function(t){return t.stopPropagation(),t.preventDefault(),"play"!==this.getGameStatus()?!1:("right"===t.direction&&"swipe"==t.type?this.moveBlock("right"):"left"===t.direction&&"swipe"==t.type?this.moveBlock("left"):"down"===t.direction&&"swipe"==t.type?this.moveHardDown():"up"===t.direction&&"swipe"==t.type?this.rotateBlock("left"):"hold"===t.type&&this.start(),void 0)},this))},getGameStatus:function(){return this.model.get("sGameStatus")},checkLevelUp:function(){this.model.get("nScore")>=100&&2>this.level?(this.level=2,this.nLogicSpeed=250):this.model.get("nScore")>=1e3&&3>this.level?(this.level=3,this.nLogicSpeed=200):this.model.get("nScore")>=2e3&&4>this.level&&(this.level=3,this.nLogicSpeed=100)},renderCanvas:function(){this.drawMyStage(),this.drawMovingBlock(),this.drawGhostBlock()},tick:function(){this.renderCanvas(),this.nTickCnt+=this.tickTime,this.nLogicTickCnt+=this.tickTime,this.nLogicTickCnt>this.nLogicSpeed&&(this.setGameStatus("play"),this.moveDown(!0),this.nLogicTickCnt-=this.nLogicSpeed),1==this.keyPressFlag&&(this.htKeyState[37]?this.moveBlock("left"):this.htKeyState[39]&&this.moveBlock("right"))},start:function(t){if("start"!==this.getGameStatus()){var e=$(this.el);t?(e.find("#start_btn").hide(),e.find("#stop_btn").hide(),e.find("#cancel_btn").hide()):(e.find("#start_btn").hide(),e.find("#stop_btn").show()),this.resetData(),this.setGameStatus("start"),this.model.set("nextBlock",[]);for(var i=0;5>=i;i++){var n=this.model.get("nextBlock");n.push(this.model.getRandomRange()),this.model.set("nextBlock",n)}this.makeNewBlock(),this.setKeyEvents(),this.stopAnimationLoop(),this.startAnimationLoop(),this.tick()}},stopAnimationLoop:function(){cancelAnimationFrame(this.ticker)},startAnimationLoop:function(){this.ticker=requestAnimationFrame($.proxy(this.startAnimationLoop,this)),this.tick()},debugStart:function(){if("start"!==this.getGameStatus()){$(".pause").remove(),this.debugMode=!0,this.setGameStatus("debug"),this.resetData(),this.model.set("nextBlock",[]);for(var t=0;5>=t;t++){var e=this.model.get("nextBlock");e.push(this.model.getRandomRange()),this.model.set("nextBlock",e)}this.makeNewBlock(),this.setKeyEvents(),this.drawMyStage()}},pause:function(){"pause"==this.model.get("sGameStatus")?(this.setGameStatus("play"),this.timer=setInterval($.proxy(this.tick,this),this.tickTime)):(clearTimeout(this.timer),this.setGameStatus("pause"))},stop:function(){$(document).unbind("keydown",$.proxy(this._onKeyAction,this)),this.setGameStatus("stop"),$(".pause").remove(),cancelAnimationFrame(this.ticker),$(this.el).find("#active").remove(),this.initMatrix(),this.drawMyStage(),this.resetData(),$("#debug_area").empty().hide()},reqReady:function(){this.stop();var t=$(this.el);t.find("#start_btn").hide(),t.find("#ready_btn").hide(),t.find("#cancel_btn").show(),t.find("#stop_btn").hide(),this.oGameIo.emit("reqReady"),this.setGameStatus("ready")},resReady:function(t){if("ok"===t.sStatus);else if("game"===t.sStatus){var e=$(this.el);e.find("#start_btn").show(),e.find("#ready_btn").show(),e.find("#cancel_btn").hide(),e.find("#stop_btn").show()}else{var e=$(this.el);e.find("#start_btn").show(),e.find("#ready_btn").show(),e.find("#cancel_btn").hide(),e.find("#stop_btn").show(),alert("resReady에서 오류가 났습니다.")}},reqCancel:function(){var t=$(this.el);t.find("#start_btn").show(),t.find("#ready_btn").show(),t.find("#cancel_btn").hide(),t.find("#stop_btn").hide(),this.oGameIo.emit("reqCancel")},resCancel:function(t){if("ok"===t.sStatus);else if("game"===t.sStatus){var e=$(this.el);e.find("#start_btn").hide(),e.find("#ready_btn").hide(),e.find("#cancel_btn").show(),e.find("#stop_btn").hide(),alert("이미 게임이 시작되었습니다.")
}else{var e=$(this.el);e.find("#start_btn").hide(),e.find("#ready_btn").hide(),e.find("#cancel_btn").show(),e.find("#stop_btn").hide(),alert("resCancel에서 오류가 났습니다.")}},makeNewBlock:function(){var t=this.model.get("oBlockCollection"),e=this.model.get("nextBlock").shift();if(this.checkGameOver())return!1;this.model.set("nextBlock",[]);var i=this.model.get("nextBlock");i.push(this.model.getRandomRange()),this.aBlock=t.at(e).get("aMatrix"),this.sBlockCode=t.at(e).get("sCode"),this.sBlockColor=t.at(e).get("sColor"),this.nBlockAngle=t.at(e).get("nAngle"),this.model.setBlockPosXY(4,-1),this.checkLevelUp()},checkCollision:function(t,e,i){for(var n,o,s=this.model.get("aMatrix"),a=!1,r=0;e.length>r;r++)for(var l=0;e[r].length>l;l++)if(n=l+t.nX,o=r+t.nY,"bottom"===i?o+=1:("left"===i||"right"===i)&&(n="left"===i?n-1:n+1),void 0!==s[o]&&void 0!==s[o][n]&&1===s[o][n].nFlag&&1===e[r][l]){a=!0;break}return a},moveDown:function(t){if(!this.checkGameOver()){var e=this.model.get("htBlockPos"),i=!1,n=this.checkCollision(e,this.aBlock,"bottom");return n?(t&&this.htSound.lockdown.play(),this.setBlockToMatrix(),this.makeNewBlock(),i=!0):(e.nY++,this.model.set({htBlockPos:e})),this.checkFullLine(),this.debugMode&&(this.drawMyStage(),this.drawMovingBlock()),i}},checkFullLine:function(){for(var t,e,i,n=this.model.get("aMatrix"),o=this.model.get("nCols"),s=this.model.get("nRows"),a=0,r=0;s+2>r;r++){e=0;for(var l=1;o+1>l;l++)1==n[r][l].nFlag&&e++;if(e==o&&s+1>r){n.splice(r,1),i=[];for(var h=0;o+1>=h;h++)t=0===h||h===o+1?1:0,i.push({nFlag:t});n.unshift(i),a++}}this.setMatrix(n),a>0&&(this.model.plusScore(2*a),this.sendData())},moveBlock:function(t){"left"===t?this.checkCollision(this.model.get("htBlockPos"),this.aBlock,"left")||this.model.get("htBlockPos").nX--:"right"===t&&(this.checkCollision(this.model.get("htBlockPos"),this.aBlock,"right")||this.model.get("htBlockPos").nX++),this.debugMode&&(this.drawMyStage(),this.drawMovingBlock())},setBlockToMatrix:function(){for(var t,e,i=this.getMatrix(),n=0;this.aBlock.length>n;n++)for(var o=0;this.aBlock[n].length>o;o++)t=o+this.model.get("htBlockPos").nX,e=n+this.model.get("htBlockPos").nY,void 0!==i[e]&&void 0!==i[e][t]&&1!==i[e][t].nFlag&&(i[e][t].nFlag=this.aBlock[n][o],i[e][t].sColor=this.sBlockColor);this.setMatrix(i),this.sendData()},setMatrix:function(t){this.model.setMatrix(t)},sendData:function(){if(this.bRealGame){var t={sGuid:this.model.get("sGuid"),aMatrix:this.model.get("aMatrix"),nScore:this.model.get("nScore")};this.oGameIo.emit("sendGameInfo",t)}},getMatrix:function(){return this.model.get("aMatrix")},initMatrix:function(){this.model.initMatrix()},getPosPixelByColor:function(t,e){return this.arColorPos[t]*e},rotateBlock:function(t){this.aBlock=this.rotateBlockArray(this.aBlock,t),this.debugMode&&(this.drawMyStage(),this.drawMovingBlock())},rotateBlockArray:function(t,e){var i,n=[],o=this.model.get("htBlockPos"),s=!1;if("O"!==this.sBlockCode&&(s=!0),("S"===this.sBlockCode||"I"===this.sBlockCode||"Z"===this.sBlockCode)&&this.nBlockAngle>0&&(e="left"),s===!0)if("right"===e){this.nBlockAngle=(this.nBlockAngle+90)%360;for(var a=t[0].length-1;a>=0;a--){i=[],i.push(t[3][a]);for(var r=0;t.length-1>r;r++)i.push(t[r][a]);n.push(i)}}else{this.nBlockAngle=(this.nBlockAngle-90)%360;for(var a=1;t.length>a;a++){i=[];for(var r=t[0].length-1;r>=0;r--)i.push(t[r][a]);n.push(i)}i=[];for(var r=t[0].length-1;r>=0;r--)i.push(t[r][0]);n.push(i)}else n=t;return this.checkCollision(o,n)&&(n=t),n},checkGameOver:function(){for(var t=0,e=this.getMatrix(),i=1;this.model.get("nCols")+1>i;i++)1==e[0][i].nFlag&&t++;return t>0?($(this.el).find("#active").remove(),cancelAnimationFrame(this.ticker),this.setGameStatus("end"),$(document).unbind("keydown",$.proxy(this.keyAction,this)),!1):void 0},clearLongPress:function(){clearInterval(this.keyLongPressChecker),this.nLongPressCnt=0},moveHardDown:function(){this.clearLongPress(),this.controlSound("harddrop","play");for(var t=!1,e=0,i=this.model.get("nRows");i>e;e++){if(1==t){this.model.get("htBlockPos").nY=-1;break}var n=!1;t=this.moveDown(n)}},_onKeyAction:function(t){var e=t.keyCode;if("keydown"==t.type&&0===this.nLongPressCnt){this.htKeyState[t.keyCode||t.which]=!0,this.nLongPressCnt=1,clearInterval(this.keyLongPressChecker);var i=this;this.keyLongPressChecker=setInterval(function(){i.nLongPressCnt++,i.keyPressFlag=i.nLongPressCnt>5?!0:!1},400)}if("keyup"==t.type&&(this.htKeyState[t.keyCode||t.which]=!1,this.nLongPressCnt=0,clearInterval(this.keyLongPressChecker)),"keyup"===t.type)return!1;if("pause"===this.model.get("sGameStatus")&&16!==e)return!1;switch(e){case 16:this.pause();break;case 32:this.moveHardDown();break;case 37:this.moveBlock("left");break;case 39:this.moveBlock("right");break;case 38:this.rotateBlock("right");break;case 40:this.moveDown(!0);break;case 90:this.rotateBlock("left");break;case 88:this.rotateBlock("right");break;default:}return!1},drawDebugStage:function(){for(var t=this.getMatrix(),e=[],i=t.length,n=t[0].length,o=0;i>o;o++){for(var s=0;n>s;s++)e.push('<div class="block">'+t[o][s].nFlag+"</div>");e.push('<div class="clear"></div>')}$("#debug_area").show().empty().append(e.join(""))}}),app.tetris.Game.WebGLView=Backbone.View.extend({defaults:{nWidth:0,nHeight:0,arCameraEye:[0,0,0],arCameraLookAt:[0,0,0],fAngleYZ:100,fAngleXZ:0,fCameraDistance:0,bCameraPerspective:!1,nFov:0,ctx:null,bWebGLAvailable:!1},isAvailWebGL:function(){return!!window.WebGLRenderingContext},initCanvas:function(){var t=this.$el[0];this.nWidth=t.width,this.nHeight=t.height,this.arCameraEye=[0,0,0],this.arCameraLookAt=[0,0,0],this.fAngleYZ=0,this.fAngleXZ=Math.PI/2,this.fCameraDistance=100,this.bCameraPerspective=!1,this.nFov=45;var e=["webgl","experimental-webgl","webkit-3d","moz-webgl"];this.ctx=null;for(var i=0;e.length>i;++i){try{this.ctx=t.getContext(e[i])}catch(n){break}if(null!=this.ctx)break}this.bWebGLAvailable=null==this.ctx?!1:!0,this.initResource(),this.initShader(),this.clear()},initResource:function(){var t=this.ctx,e=[-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5];this.gl_VB_Position_Cube=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.gl_VB_Position_Cube),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW),this.gl_VB_Position_Cube.itemSize=3,this.gl_VB_Position_Cube.numItems=24,t.bindBuffer(t.ARRAY_BUFFER,null);var i=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];this.gl_VB_Color_Cube=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.gl_VB_Color_Cube),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW),this.gl_VB_Color_Cube.itemSize=4,this.gl_VB_Color_Cube.numItems=24,t.bindBuffer(t.ARRAY_BUFFER,null);var n=[0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1];this.gl_VB_Cordinate_Cube=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.gl_VB_Cordinate_Cube),t.bufferData(t.ARRAY_BUFFER,new Float32Array(n),t.STATIC_DRAW),this.gl_VB_Cordinate_Cube.itemSize=2,this.gl_VB_Cordinate_Cube.numItems=24,t.bindBuffer(t.ARRAY_BUFFER,null);var o=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];this.gl_IB_Cube=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.gl_IB_Cube),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(o),t.STATIC_DRAW),this.gl_IB_Cube.itemSize=1,this.gl_IB_Cube.numItems=36,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.gl_Tex_Cube=t.createTexture(),WebGLUtil.loadImage(t,this.gl_Tex_Cube,"res/img/mino_main2.png")},initShader:function(){var t=this.ctx;this.gl_Shader_RenderProgram=t.createProgram();var e=this.vertexShaderText,i=WebGLUtil.createShader(t,e,t.VERTEX_SHADER),n=this.fragmentShaderText,o=WebGLUtil.createShader(t,n,t.FRAGMENT_SHADER);return null==i||null==o?(alert("Shader can not compile"),!1):(t.attachShader(this.gl_Shader_RenderProgram,i),t.attachShader(this.gl_Shader_RenderProgram,o),t.deleteShader(i),t.deleteShader(o),t.linkProgram(this.gl_Shader_RenderProgram),t.getProgramParameter(this.gl_Shader_RenderProgram,t.LINK_STATUS)?(t.useProgram(this.gl_Shader_RenderProgram),this.gl_Attribute_VertexPosition=t.getAttribLocation(this.gl_Shader_RenderProgram,"aVertexPosition"),this.gl_Attribute_VertexColor=t.getAttribLocation(this.gl_Shader_RenderProgram,"aVertexColor"),this.gl_Attribute_VertexCordinate=t.getAttribLocation(this.gl_Shader_RenderProgram,"aVertexCordinate"),this.gl_Uniform_WorldMatrix=t.getUniformLocation(this.gl_Shader_RenderProgram,"uWorldMatrix"),this.gl_Uniform_ViewMatrix=t.getUniformLocation(this.gl_Shader_RenderProgram,"uViewMatrix"),this.gl_Uniform_ProjectionMatrix=t.getUniformLocation(this.gl_Shader_RenderProgram,"uProjectionMatrix"),this.gl_Uniform_Texture=t.getUniformLocation(this.gl_Shader_RenderProgram,"uTexture"),this.gl_Uniform_ModulateCordinate=t.getUniformLocation(this.gl_Shader_RenderProgram,"uModulateCordinate"),this.gl_Uniform_Color=t.getUniformLocation(this.gl_Shader_RenderProgram,"uColor"),t.useProgram(null),void 0):(alert("Could not initialize shaders"),!1))},initialize:function(){this.vertexShaderText=WebGLUtil.loadShader("res/shader/model.vs"),this.fragmentShaderText=WebGLUtil.loadShader("res/shader/model.fs")},drawBlock:function(t,e,i,n,o){var s=this.ctx;s.useProgram(this.gl_Shader_RenderProgram),s.enableVertexAttribArray(this.gl_Attribute_VertexPosition),s.enableVertexAttribArray(this.gl_Attribute_VertexColor),s.enableVertexAttribArray(this.gl_Attribute_VertexCordinate);var a=[0,0,0];a[0]=this.fCameraDistance*Math.cos(this.fAngleYZ)*Math.cos(this.fAngleXZ),a[1]=this.fCameraDistance*Math.sin(this.fAngleYZ),a[2]=this.fCameraDistance*Math.cos(this.fAngleYZ)*Math.sin(this.fAngleXZ),this.arCameraEye[0]=this.arCameraLookAt[0]+a[0],this.arCameraEye[1]=this.arCameraLookAt[1]+a[1],this.arCameraEye[2]=this.arCameraLookAt[2]+a[2];var r=mat4.create(),l=mat4.create(),h=mat4.create();mat4.identity(r),mat4.scale(r,[i,i,i],r),mat4.translate(r,[t,e,0],r),mat4.lookAt(this.arCameraEye,this.arCameraLookAt,[0,1,0],l),1==this.bCameraPerspective?mat4.perspective(this.nFov,this.nWidth/this.nHeight,.1,1e3,h):0==this.bCameraPerspective&&mat4.ortho(-this.nWidth/2,this.nWidth/2,-this.nHeight/2,this.nHeight/2,.1,1e3,h),s.uniformMatrix4fv(this.gl_Uniform_WorldMatrix,!1,r),s.uniformMatrix4fv(this.gl_Uniform_ViewMatrix,!1,l),s.uniformMatrix4fv(this.gl_Uniform_ProjectionMatrix,!1,h),1==this.gl_Tex_Cube.bIsLoaded&&(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.gl_Tex_Cube),s.uniform1i(this.gl_Uniform_Texture,0)),s.uniform4fv(this.gl_Uniform_ModulateCordinate,[.0625,1,.0625*n,0]),s.uniform4fv(this.gl_Uniform_Color,o),s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),1>o[3]?(s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.blendEquation(s.FUNC_ADD)):s.disable(s.BLEND),s.bindBuffer(s.ARRAY_BUFFER,this.gl_VB_Position_Cube),s.vertexAttribPointer(this.gl_Attribute_VertexPosition,this.gl_VB_Position_Cube.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this.gl_VB_Color_Cube),s.vertexAttribPointer(this.gl_Attribute_VertexColor,this.gl_VB_Color_Cube.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this.gl_VB_Cordinate_Cube),s.vertexAttribPointer(this.gl_Attribute_VertexCordinate,this.gl_VB_Cordinate_Cube.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.gl_IB_Cube),s.drawElements(s.TRIANGLES,this.gl_IB_Cube.numItems,s.UNSIGNED_SHORT,0),s.bindBuffer(s.ARRAY_BUFFER,null),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),s.bindTexture(s.TEXTURE_2D,null),s.disableVertexAttribArray(this.gl_Attribute_VertexPosition),s.disableVertexAttribArray(this.gl_Attribute_VertexColor),s.disableVertexAttribArray(this.gl_Attribute_VertexCordinate),s.useProgram(null)},clear:function(){var t=this.ctx;t.clearColor(0,0,0,0),t.viewport(0,0,this.nWidth,this.nHeight),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}}),app.tetris.Rules.arBlockList=function(){var t=[];return t[0]=new app.tetris.Game.BlockModel({sColor:"yellow",sCode:"O",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]}),t[1]=new app.tetris.Game.BlockModel({sColor:"sky",sCode:"I",nAngle:0,aMatrix:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]]}),t[2]=new app.tetris.Game.BlockModel({sColor:"orange",sCode:"L",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,1],[0,1,0,0],[0,0,0,0]]}),t[3]=new app.tetris.Game.BlockModel({sColor:"blue",sCode:"J",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,1],[0,0,0,1],[0,0,0,0]]}),t[4]=new app.tetris.Game.BlockModel({sColor:"green",sCode:"S",nAngle:0,aMatrix:[[0,0,0,0],[0,0,1,1],[0,1,1,0],[0,0,0,0]]}),t[5]=new app.tetris.Game.BlockModel({sColor:"red",sCode:"Z",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,0],[0,0,1,1],[0,0,0,0]]}),t[6]=new app.tetris.Game.BlockModel({sColor:"purple",sCode:"T",nAngle:0,aMatrix:[[0,0,0,0],[0,1,1,1],[0,0,1,0],[0,0,0,0]]}),t}(),function(){var t=Backbone.View.extend({el:"#_container #_menu_view",template:"menu",events:{"click ._menu_item":"onClickMenu"},initialize:function(){this.render(),this.oBgm=new Howl({urls:["../res/sound/FF_8_OST.mp3"],volume:.1,format:"mp3"}),app.tetris.Network.Model.on("change:nRegisterUser change:nConnectedUser",$.proxy(function(t){this.onChangeCount(t)},this))},onChangeCount:function(t){var e=this.$el.find("._conn_user_cnt");e.find("._con_user").html(t.get("nConnectedUser")),e.find("._reg_user").html(t.get("nRegisterUser")),e.removeClass("pulse").hide().addClass("pulse").show()},onClickMenu:function(t){var e=$(t.currentTarget).attr("data-navigate");return app.tetris.Router.navigate(e,{trigger:!0}),!1},show:function(){this.render(),this.$el.show(),this.$el.find("._welcome").addClass("animated").addClass("pulse"),this.$el.addClass("animated").removeClass("fadeOutUp").addClass("fadeInDown"),this.$el.find("._conn_user_cnt").removeClass("pulse").addClass("animated").addClass("pulse").show();var t=this;setTimeout(function(){t.myScroll&&t.myScroll.refresh()},200)},hide:function(){this.$el.addClass("animated").removeClass("fadeInDown").addClass("fadeOutUp")},render:function(){var t={sName:app.tetris.Account.Info.userId,nConnectedUser:app.tetris.Network.Model.get("nConnectedUser"),nRegisterUser:app.tetris.Network.Model.get("nRegisterUser")},e=app.tetris.TemplateManager.get(this.template,t);return this.$el.html(e),this.myScroll=new IScroll("#wrapper_scroll",{scrollX:!1,scrollY:!0,momentum:!0,click:!0}),this}});app.tetris.Menu.View=new t}(),app.tetris.init=function(){app.tetris.ui.BackButton.setEvents(),Backbone.history.start();var t=Backbone.history.fragment?Backbone.history.fragment:!1;app.tetris.Router.navigate(t,{trigger:!0})},function(){var t=app.tetris,e=Backbone.Router.extend({routes:{login:"moveToStart",menu:"moveToMenu",single:"moveToSingleGame",multi:"moveToMultiGame",board:"moveToGameBoard",credit:"moveToCredit",logout:"moveToLogout","":"moveToStart"},execute:function(t,e){app.tetris.Account.Info.load();var i=Backbone.history.fragment;!app.tetris.Account.Info.isAuthenticated()&&"login"!==i,t&&t.apply(this,e)},initialize:function(){this._welContainer=$("#_container"),this._hideAllScreens()},_hideAllScreens:function(){this._welContainer.find("._screen").hide(),this._welContainer.removeClass("animated").removeClass("fadeInDown"),t.ui.Header.View.hide(),t.ui.Footer.View.hide(),t.ui.BackButton.hide()},moveToStart:function(){this._hideAllScreens(),t.Account.View.show()},moveToLogout:function(){app.tetris.Account.Info.clear(),this.navigate("login",{trigger:!0})},moveToMultiGame:function(){this._hideAllScreens(),t.Menu.View.show()},moveToGameBoard:function(){this._hideAllScreens(),t.Board.init(),t.Board.View.show(),t.ui.Header.View.changeTitle("GameBoard").show(),t.ui.Footer.View.show(),t.ui.BackButton.show()},moveToCredit:function(){this._hideAllScreens(),t.Credit.View.show(),t.ui.Header.View.changeTitle("Credit").show(),t.ui.BackButton.show()},moveToSingleGame:function(){this._hideAllScreens(),t.ui.BackButton.show(),t.Game.StageView.show();var e=t.Game.init({sTargetId:"game_area",bUseWebGL:!0});e.on("ready",function(t){t.oGameView.show()})},moveToMenu:function(){this._hideAllScreens(),t.Menu.View.show()}});t.Router=new e}();